(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{XSib:function(t,r,n){var o=o||{};o=function(t){function r(t){var r={getCorrelationMatrix:function(t){for(var r=o(this.nbRows,this.nbColumns,t),n=0;n<r.nbRows;++n){for(var i=Math.sqrt(this.data[n*this.nbColumns+n]),e=0;e<n;++e)r.data[n*r.nbColumns+e]=r.data[e*this.nbColumns+n];r.data[n*r.nbColumns+e]=1;for(e=n+1;e<r.nbColumns;++e){var a=Math.sqrt(this.data[e*this.nbColumns+e]);r.data[n*r.nbColumns+e]=this.data[n*this.nbColumns+e]/(i*a)}}return r},getVariances:function(t){return this.diagonal(t)},getStandardDeviations:function(t){return this.diagonal(t).elemMap((function(t,r,n){return Math.sqrt(n)}),t)},standardizedGeneralizedVariance:function(){var t=this.determinant();if(t<0)throw new Error("covariance matrix is not positive semi-definite");return Math.pow(t,1/this.nbRows)}};for(var n in r)t[n]=r[n]}function n(t){function r(t){var r=Object.prototype.toString.call(t);return"[object Array]"===r||"[object Int8Array]"===r||"[object Uint8Array]"===r||"[object Uint8ClampedArray]"===r||"[object Int16Array]"===r||"[object Uint16Array]"===r||"[object Int32Array]"===r||"[object Uint32Array]"===r||"[object Float32Array]"===r||"[object Float64Array]"===r}if(!(this instanceof n))return new n(t);var i=this;if(r(t)&&r(t[0]))return function(t){i=o(t.length,t[0].length);for(var n=0;n<i.nbRows;++n){if(!r(t[n]))throw new Error("unsupported input type");if(t[n].length!==i.nbColumns)throw new Error("unsupported input type");for(var e=0;e<i.nbColumns;++e)i.data[n*i.nbColumns+e]=t[n][e]}return i}(t);if(r(t))return function(t){i=o(t.length,1);for(var r=0;r<i.nbRows;++r)i.data[r*i.nbColumns]=t[r];return i}(t);if(t instanceof n)return function(t){i=o(t.nbRows,t.nbColumns);for(var r=t.nbRows*t.nbColumns,n=0;n<r;++n)i.data[n]=t.data[n];return i}(t);throw new Error("unsupported input type")}function o(t,r,o){var i;if(void 0===o)(i=Object.create(n.prototype)).nbRows=t,i.nbColumns=r,i.data="function"==typeof Float64Array?new Float64Array(i.nbRows*i.nbColumns):new Array(i.nbRows*i.nbColumns);else{if(!(o instanceof n))throw new Error("provided output must be a matrix");if(o.nbRows!==t||o.nbColumns!==r)throw new Error("provided output matrix size does not match expected matrix size: ("+o.nbRows+","+o.nbColumns+") v.s. ("+t+","+r+")");i=o}return i}function e(t){if(!(this instanceof e))return new e;this.WORD_LENGTH=32,this.WORD_LOG=5,this.words="function"==typeof Uint32Array?new Uint32Array(0):new Array(0);var r=this;(t instanceof Array||"function"==typeof Uint32Array&&t instanceof Uint32Array)&&function(t){for(var n=0;n<t.length;++n)r.set(t[n])}(t),this.iterator=function(){for(this.w_idx=-1,this.w=0;this.w_idx<r.words.length&&0==this.w;)++this.w_idx,this.w=r.words[this.w_idx];this.next=function(){if(this.w_idx==r.words.length)return 0;var t=this.w&-this.w,n=(this.w_idx<<r.WORD_LOG)+e.populationCount(t-1|0);for(this.w^=t;this.w_idx<r.words.length&&0==this.w;)++this.w_idx,this.w=r.words[this.w_idx];return n}}}function s(t){this.prob="function"==typeof Float64Array?new Float64Array(t.length):new Array(t.length),this.alias="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length);for(var r=1/t.length,n="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length),o=0,i="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length),e=0,a=0;a<t.length;++a)t[a]>r?(i[e]=a,++e):(n[o]=a,++o);for(t=t.slice(0);o>0&&e>0;){a=n[--o];var s=i[--e];this.prob[a]=t.length*t[a],this.alias[a]=s,t[s]=t[s]+(t[a]-r),t[s]>r?(i[e]=s,++e):(n[o]=s,++o)}for(;o>0;)--o,this.prob[n[o]]=1;for(;e>0;)--e,this.prob[i[e]]=1;this.sample=function(){var t=Math.random()*this.prob.length,r=Math.floor(t);return t-r<=this.prob[r]?r:this.alias[r]}}function u(t,r,n){this.n=t,this.k=r,this.reuseOutputArray=n,this.firstcall=!0,this.mtc=!1,this.r="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.t=this.n,this.h=0,this.next=function(){if(!this.firstcall&&!this.mtc)return-1;if(this.firstcall){this.firstcall=!1,this.r[0]=this.n;for(var t=1;t<=this.k-1;++t)this.r[t]=0}else this.t>1&&(this.h=0),++this.h,this.t=this.r[this.h-1],this.r[this.h-1]=0,this.r[0]=this.t-1,++this.r[this.h];return this.mtc=this.r[this.k-1]!=this.n,this.reuseOutputArray?this.r:this.r.slice(0)}}function l(t,r,n){if(void 0===r){this.r="function"==typeof Uint32Array?new Uint32Array(t):new Array(t);for(var o=0;o<t;++o)this.r[o]=o+1}else this.r=r;function i(){for(var t=Math.random();0===t;)t=Math.random();return t}this.rrlen=this.r.length,this.reuseOutputArray=n,this.next=function(){if(this.reuseOutputArray)var t=this.r;else t=this.r.slice(0);for(var r=1;r<=this.rrlen;++r){var n=r+Math.floor(i()*(this.rrlen+1-r)),o=t[n-1];t[n-1]=t[r-1],t[r-1]=o}return t}}function f(t,r,n){this.n=t,this.k=r,this.useArrayCopy=n,this.a="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.firstcall=!0,this.mtc=!1,this.m2=0,this.h=this.k,this.endval=this.n-this.k+1,this.next=function(){if(!(this.firstcall||this.mtc&&0!==this.k))return-1;this.firstcall?this.firstcall=!1:(this.m2<this.n-this.h&&(this.h=0),++this.h,this.m2=this.a[this.k-this.h]);for(var t=1;t<=this.h;++t)this.a[this.k+t-this.h-1]=this.m2+t;return this.mtc=this.a[0]!=this.endval,this.useArrayCopy?this.a.slice(0):this.a}}function h(t,r,n){function o(){for(var t=Math.random();0===t;)t=Math.random();return t}this.n=t,this.k=r,this.useArrayCopy=n,this.a="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.N,this.nn,this.idx_a,this.selected_record,this.method_a=function(){for(var t=this.N-this.nn;this.nn>=2;){for(var r=o(),n=0,i=t/this.N;i>r;)++n,--t,--this.N,i=i*t/this.N;this.selected_record+=n+1,this.a[this.idx_a++]=this.selected_record,--this.N,--this.nn}(n=Math.floor(this.N*o()))===this.N&&(n=this.N-1),this.selected_record+=n+1,this.a[this.idx_a++]=this.selected_record},this.method_d=function(){for(var t=1/this.nn,r=Math.pow(o(),t),n=1-this.nn+this.N,i=13*this.nn;this.nn>1&&i<this.N;){for(var e,a,s=1/(-1+this.nn);;){for(;e=this.N*(1-r),!((a=Math.floor(e))<n);)r=Math.pow(o(),t);var u=o(),l=Math.pow(u*this.N/n,s);if((r=l*(-e/this.N+1)*(n/(-a+n)))<=1)break;var f,h,m=1,c=-1+this.N;-1+this.nn>a?(f=-this.nn+this.N,h=-a+this.N):(f=-1-a+this.N,h=n);for(var d=-1+this.N;d>=h;--d)m=m*c/f,--c,--f;if(this.N/(-e+this.N)>=l*Math.pow(m,s)){r=Math.pow(o(),s);break}r=Math.pow(o(),t)}this.selected_record+=a+1,this.a[this.idx_a++]=this.selected_record,this.N=-a+(-1+this.N),--this.nn,t=s,n=-a+n,i+=-13}this.nn>1?this.method_a():((a=Math.floor(this.N*r))===this.N&&(a=this.N-1),this.selected_record+=a+1,this.a[this.idx_a++]=this.selected_record)},this.next=function(){for(var t=0;t<this.k;++t)this.a[t]=0;return this.N=this.n,this.nn=this.k,this.idx_a=0,this.selected_record=0,this.method_d(),this.useArrayCopy?this.a.slice(0):this.a}}function m(t){this.n=t,this.firstcall=!0,this.mtc=!1,this.iin="function"==typeof Uint32Array?new Uint32Array(t):new Array(t),this.ncard=0,this.next=function(){var t=[];if(!this.firstcall&&!this.mtc)return-1;if(this.firstcall){this.firstcall=!1;for(var r=0;r<=this.n-1;++r)this.iin[r]=0;this.mtc=!0}else{var n=0;if(this.ncard%2!=0)for(++n;0==this.iin[n-1];)++n;this.iin[n]=1-this.iin[n],this.ncard=this.ncard+2*this.iin[n]-1,t="function"==typeof Uint32Array?new Uint32Array(this.ncard):new Array(this.ncard);var o=0;for(r=0;r<=this.n-1;++r)1==this.iin[r]&&(t[o++]=r+1);this.mtc=this.ncard!=this.iin[this.n-1]}return t}}function c(t){for(var r=t.length,o=t[0].nbRows,i=n.zeros(o,1),e=1;e<=o;++e){for(var a=0,s=0;s<r;++s)a+=t[s].getValue(e,1);var u=a/r,l=0;for(s=0;s<r;++s)l+=t[s].getValue(e,1)-u;i.setValue(e,1,(a+l)/r)}return i}function d(t,r,o){t=new n(t),r=new n(r),o=new n(o);if(r.nbRows!=t.nbRows||o.nbRows!=t.nbRows)throw new Error("incompatible dimensions: "+t.nbRows+", "+r.nbRows+", "+o.nbRows);var i=n.xmy(o,r),e=n.xmy(t,r),a=i.vectorNorm("two");if(a<=1e-8)return r.toArray();var s=Math.max(0,Math.min(1,n.vectorDotProduct(i,e)/(a*a)));return n.axpby(1,r,s,i).toArray()}function w(t,r,n){var o=t;n||(o=t.slice(0).sort((function(t,r){return t-r})));var i=r*(t.length-1),e=Math.floor(i);return e==i?o[e]:o[e]+(o[e+1]-o[e])*(i-e)}function p(t,r,n,o){if(this.n=t,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.reuseOutputArray=o,this.l=r,!this.l){this.l="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n);for(var i=0;i<this.n;++i)this.l[i]=0}if(this.u=n,!this.u){this.u="function"==typeof Float64Array?new Float64Array(this.n):new Array(this.n);for(i=0;i<this.n;++i)this.u[i]=1}for(i=0;i<this.n;++i)if(this.l[i]>this.u[i])throw new Error("empty box detected: lower bound strictly greater than upper bound");this.sample=function(){for(var t=0;t<this.n;++t)this.x[t]=Math.random()*(this.u[t]-this.l[t])+this.l[t];return this.reuseOutputArray?this.x:this.x.slice(0)}}function v(t,r){r=r||function(t,r){return t-r};for(var n=t.length,o=t[0],i=0,e=1;e<n;++e)r(t[e],o)>0&&(o=t[e],i=e);return[o,i]}function b(t,r,n){n=n||function(t,r){return t-r};var o=t.length,i="function"==typeof UInt32Array?new UInt32Array(10):new Array(10),e="function"==typeof UInt32Array?new UInt32Array(10):new Array(10),a=0,s=0,u=o-1;for(r=r-1;;)if(u-s>600&&a<10){var l=u-s+1,f=r-s+1,h=l,m=Math.log(h),c=Math.floor(.5*Math.exp(2*m/3)+.5),d=f>=h/2?1:-1,w=.5*Math.sqrt(m*c*(1-c/h))*d+.5;w=-1<w&&w<1?0:w>=1?Math.floor(w):Math.ceil(w),f==l/2&&(w=0),i[a]=s,e[a]=u,a++;var p=r-f*(c/h)+w;s<p&&(s=Math.floor(p+.5)),u>p+c&&(u=Math.floor(p+c+.5))}else{if(s>=u){if(0==a)return t[r];s=i[--a],u=e[a]}var v=t[r];for(f=s,j=u,t[r]=t[s],t[s]=v,n(v,t[u])<0&&(t[s]=t[u],t[u]=v);f<j;){var b=t[j];for(t[j]=t[f],t[f]=b,++f,--j;n(t[f],v)<0;)++f;for(;n(t[j],v)>0;)--j}if(0==n(t[s],v)){b=t[s];t[s]=t[j],t[j]=b}else{++j;b=t[j];t[j]=t[u],t[u]=b}j<=r&&(s=j+1),r<=j&&(u=j-1)}}function y(t){var r=Math.pow(2,-52),n=(2-r)*Math.pow(2,1023),o=Math.pow(2,-1022);if(t!=t)return t;if(t===-1/0)return-n;if(t===1/0)return 1/0;if(t===+n)return 1/0;var i=t*(t<0?1-r/2:1+r);i===t&&(i=o*r>0?t+o*r:t+o),i===1/0&&(i=+n);var e=t+(i-t)/2;t<e&&e<i&&(i=e);var a=(i+t)/2;return t<a&&a<i&&(i=a),0===i?-0:i}function g(t,r){var n=0,o=Math.abs(t),i=Math.abs(r);return o>i?(n=r/t,n=o*Math.sqrt(1+n*n)):0!=r?(n=t/r,n=i*Math.sqrt(1+n*n)):n=0,n}function x(t){for(var r,n=t.length,o=0,i=0;i<n;++i)o+=t[i];r=o/n;var e=0;for(i=0;i<n;++i)e+=t[i]-r;return(o+e)/n}function C(t){for(var r=t.length,n=x(t),o=0,i=0,e=0;e<r;++e){var a=t[e]-n;o+=a*a,i+=a}return(o-i*i/r)/r}function R(t){return Math.sqrt(function(t){var r=t.length;return C(t)*r/(r-1)}(t))}function E(t){var r=t,n=0,o=t,i=t*t,e=1;if(t<-8)return 0;if(t>8)return 1;for(;r!=n;)r=(n=r)+(o*=i/(e+=2));return.5+r*Math.exp(-.5*i-.9189385332046728)}function M(t,r){null==t&&(t=0),null==r&&(r=1);for(var n=Math.random();0===n;)n=Math.random();return t+r*function(t){if(t<=0||t>=1){if(0==t)return-1/0;if(1==t)return 1/0;throw"The probality p must be bigger than 0 and smaller than 1"}var r,n=t-.5;if(Math.abs(n)<=.425){r=n*(((((((2509.0809287301227*(o=.180625-n*n)+33430.57558358813)*o+67265.7709270087)*o+45921.95393154987)*o+13731.69376550946)*o+1971.5909503065513)*o+133.14166789178438)*o+3.3871328727963665)/(((((((5226.495278852854*o+28729.085735721943)*o+39307.89580009271)*o+21213.794301586597)*o+5394.196021424751)*o+687.1870074920579)*o+42.31333070160091)*o+1)}else{var o;if(o=n<0?t:1-t,(o=Math.sqrt(-Math.log(o)))<=5)r=(((((((.0007745450142783414*(o-=1.6)+.022723844989269184)*o+.2417807251774506)*o+1.2704582524523684)*o+3.6478483247632045)*o+5.769497221460691)*o+4.630337846156546)*o+1.4234371107496835)/(((((((1.0507500716444169e-9*o+.0005475938084995345)*o+.015198666563616457)*o+.14810397642748008)*o+.6897673349851)*o+1.6763848301838038)*o+2.053191626637759)*o+1);else r=(((((((2.0103343992922881e-7*(o-=5)+27115555687434876e-21)*o+.0012426609473880784)*o+.026532189526576124)*o+.29656057182850487)*o+1.7848265399172913)*o+5.463784911164114)*o+6.657904643501103)/(((((((20442631033899397e-31*o+1.421511758316446e-7)*o+18463183175100548e-21)*o+.0007868691311456133)*o+.014875361290850615)*o+.1369298809227358)*o+.599832206555888)*o+1);n<0&&(r=-r)}return r}(n)}function A(t,r){this.n=t,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.reuseOutputArray=r,this.sample=function(){for(var t=0,r=1,n=0;n<this.n;++n){var o=M();this.x[n]=o;var i=Math.abs(o);0!=i&&(i>t?(r=1+r*(t/o)*(t/o),t=i):r+=o/t*(o/t))}var e=t*Math.sqrt(r);for(n=0;n<this.n;++n)this.x[n]=this.x[n]/e;return this.reuseOutputArray?this.x:this.x.slice(0)}}function P(t,r){for(var n=t.length,o=x(t),i=x(r),e=0,a=0,s=0,u=0;u<n;++u){var l=t[u]-o,f=r[u]-i;e+=l*f,a+=l,s+=f}return(e-a*s/n)/n}function z(t,r){var n=t.length;return P(t,r)*n/(n-1)}function k(t,r,n){void 0===n&&(n={});var o=n.nRounds;void 0===o&&(o=10);var i=n.nSteps;void 0===i&&(i=5e3);var e=n.nDeltas;void 0===e&&(e=i);var a=n.neighbourGenerator,s=n.neighbourGeneratorParameters;void 0===a&&(a=function(t,r){for(var n=r.alpha,o=r.lowerBounds,i=r.upperBounds,e=t.length,a=t.slice(),s=t.slice(),u=0;u<e;++u)a[u]=t[u]-n/2,s[u]=t[u]+n/2,o&&(a[u]=Math.max(a[u],o[u])),i&&(s[u]=Math.min(s[u],i[u]));return{xx:new p(e,a,s).sample()}},void 0!==s&&void 0!==s.alpha||(s={alpha:.001}));r.nbRows;for(var u=function(t,r,n,o,i){for(var e=r,s=t(e),u=s.f_x,l=s.f_x_context,f="function"==typeof Float64Array?new Float64Array(o):new Array(o),h=0;h<o;++h){var m=a(e.slice(),n),c=m.xx,d=t(c,{x_c:e,f_x_c:u,f_x_c_context:l,x_c_updatedIndexes:m.x_updated_indexes}),p=d.f_x,v=d.f_x_context;f[h]=Math.abs(u-p),e=c,u=p,l=v}f.sort((function(t,r){return t-r}));var b="function"==typeof Float64Array?new Float64Array(i):new Array(i);for(h=0;h<i;++h)b[h]=w(f,(i-(h+1))/i,!0);return b[i-1]=0,b}(t,r,s,e,o),l=r,f=t(l),h=f.f_x,m=f.f_x_context,c=l,d=h,v=0;v<o;++v)for(var b=0;b<i;++b){var y=a(l.slice(),s),g=y.xx,x=t(g,{x_c:l,f_x_c:h,f_x_c_context:m,x_c_updatedIndexes:y.x_updated_indexes}),C=x.f_x,R=x.f_x_context;C-h<u[v]&&(l=g,h=C,m=R),C<d&&(d=C,c=g)}return[c,d]}function _(t,r,n,o){void 0===o&&(o={});var i=o.maxIter;void 0===i&&(i=45);var e=o.eps;void 0===e&&(e=1e-6);var a=o.outputInterval;void 0===a&&(a=!1);var s,u,l=t(r),f=t(n);if(r>=n)throw new Error("bracketing interval lower bound "+r+" greater than bracketing interval upper bound "+n);if(0==l)return a?[r,r+e]:r;if(0==f)return a?[n-e,n]:n;if(l*f>0)throw new Error("interval ["+r+","+n+"] is not a bracketing interval");l<=0?(s=r,u=n-r):(s=n,u=r-n);for(var h=0;;){if(-1!==i&&h>i)throw new Error("maximum number of iterations reached: "+i);++h;var m=s+(u/=2),c=t(m);if(c<=0&&(s=m),Math.abs(u)<=e||0==c)return a?[Math.max(r,s-e/2),Math.min(n,s+e/2)]:s}}function I(t,r,o,i,e,a){function s(r){return t(r)+o(r)}function u(t,r,o){var e=n.axpby(1,r,-t,o);return[e,n.copy(i(e,t))]}void 0===a&&(a={});for(var l,f,h,m,c,d,w,p,v,b,y,g,x,C,R,E,M=a.eps||1e-4,A=a.maxIter||1e4,P=a.maxLine||100,z=a.beta||.5,k=a.alphaMin||1e-10,_=a.alphaMax||1e10,I=a.restartPeriod||1e3,V=e.nbRows,F=.5,O=k,T=n.zeros(V,1),S=n.zeros(V,1),N=n.zeros(V,1),W=n.zeros(V,1),q=n.zeros(V,1),B=!0,L=0;;){if(-1!==A&&L>A)throw new Error("maximum number of iterations reached: "+A);++L%I==0&&(e=c,B=!0),!0===B&&(l=0,f=1,h=1,m=null,c=new n(e),d=new n(c),new n(d),w=n.zeros(V,1),T=n.copy(r(c),T),S=n.copy(T,S),N=n.copy(S,N),p=n.zeros(V,1),W=n.copy(c,W),q=n.copy(T,q),B=!1);for(var U=O,D=u(U,W,q),G=D[0],H=D[1],j=0;s(H)>(v=U,b=H,g=q,x=void 0,C=void 0,R=void 0,E=void 0,x=t(y=W),C=n.xmy(b,y),R=C.vectorNorm("two"),E=o(b),x+n.vectorDotProduct(C,g)+1/(2*v)*R*R+E+1e-12);){if(-1!==P&&j>P)throw new Error("maximum number of line searches reached: "+P+" at iteration: "+L);++j,U*=z,h/=z,f=(1+Math.sqrt(1+4*h*l*l))/2,G=(D=u(U,W=n.axpby(1,d,(l-1)/f,w,W),q=n.axpby(1,S,(l-1)/f,p,q)))[0],H=D[1]}c=H,T=n.copy(r(c),T);var Y=n.xmy(c,d),K=n.xmy(T,S),J=n.vectorDotProduct(Y,Y),X=Math.max(n.vectorDotProduct(K,K),1e-12),Z=n.vectorDotProduct(Y,K);if(Z<=1e-12)mu_kp_0=_;else{var Q=Math.max(k,Math.min(J/Z,_)),$=Math.max(k,Math.min(Z/X,_));$/Q<=F?(mu_kp_0=$,F*=.9):(mu_kp_0=Q,F*=1.1)}m=U/mu_kp_0;var tt=(1+Math.sqrt(1+4*m*f*f))/2,rt=n.axpby(1,c,(f-1)/tt,Y),nt=n.axpby(1,T,(f-1)/tt,K),ot=n.axpby(1/U,G,-1/U,c);if(n.xpy(T,ot).vectorNorm("infinity")<=M)break;n.vectorDotProduct(n.xmy(W,c),Y)>=1e-12&&(e=c,B=!0),O=mu_kp_0,d,d=c,w=Y,N=n.copy(S,N),S=n.copy(T,S),p=K,W=n.copy(rt,W),q=n.copy(nt,q),h=m,l=f,f=tt}return[c,s(c)]}function V(t,r,o,i,a,s,u){function l(t,r){return t instanceof Array?(t.length=r,t):t instanceof Float64Array||t instanceof Int32Array?t.subarray(0,r):void 0}function f(n){for(var i=g-n*x+C,e=new y.iterator,u=e.next();0!=u;){var l,f=u-1;n<=v[f]?l=s.data[f]:v[f]<=n&&n<=p[f]?l=(r.data[f]-n*o.data[f])/t.data[f]:p[f]<=n&&(l=a.data[f]),i+=o.data[f]*l,u=e.next()}return i}void 0===u&&(u={});var h=u.eps||1e-16,m=u.outputLagrangeMultiplier;if(!(t instanceof n&&t.isVector()))throw new Error("first input must be a vector");if(!(r instanceof n&&r.isVector()))throw new Error("second input must be a vector");if(!(o instanceof n&&o.isVector()))throw new Error("third input must be a vector");if(!(a instanceof n&&a.isVector()))throw new Error("fifth input must be a vector");if(!(s instanceof n&&s.isVector()))throw new Error("sixth input must be a vector");if(t.nbRows!==r.nbRows)throw new Error("first and second inputs number of rows do not match: "+t.nbRows+"-"+r.nbRows);if(t.nbRows!==o.nbRows)throw new Error("first and third inputs number of rows do not match: "+t.nbRows+"-"+o.nbRows);if(t.nbRows!==a.nbRows)throw new Error("first and fifth inputs number of rows do not match: "+t.nbRows+"-"+a.nbRows);if(t.nbRows!==s.nbRows)throw new Error("first and sixth inputs number of rows do not match: "+t.nbRows+"-"+s.nbRows);for(var c=o.nbRows,d=Math.abs(i),w="function"==typeof Float64Array?new Float64Array(2*c):new Array(2*c),p="function"==typeof Float64Array?new Float64Array(c):new Array(c),v="function"==typeof Float64Array?new Float64Array(c):new Array(c),y=(new e).setRange(1,c),g=0,x=0,C=0,R=1/0,E=-1/0,M=0,A=0;M<c;++M){if(a.data[M]>s.data[M])throw new Error("infeasible problem detected");if(o.data[M]<=0)throw new Error("negative element detected in b");if(t.data[M]<=0)throw new Error("negative element detected in d");var P=(r.data[M]-a.data[M]*t.data[M])/o.data[M];p[M]=P,w[A++]=P;var z=(r.data[M]-s.data[M]*t.data[M])/o.data[M];v[M]=z,w[A++]=z,P>E&&(E=P),z<R&&(R=z)}var k=f(R),_=f(E);if(k<i||_>i)throw new Error("infeasible problem detected");var I=null;if(Math.abs(k-i)<=h*d)I=R;else if(Math.abs(k-i)<=h*d)I=E;else{for(var V=R,F=E;0!=w.length;){var O=Math.ceil(w.length/2),T=b(w,O),S=f(T);if(Math.abs(S-i)<=h*d){I=T;break}if(S>i){V=T;for(A=0,M=O;M<w.length;++M)w[A++]=w[M];w=l(w,A)}else S<i&&(F=T,w=l(w,O-1));for(var N=new y.iterator,W=N.next();0!=W;){var q=!1;if(p[M=W-1]<=V&&(C+=o.data[M]*a.data[M],q=!0),F<=v[M]&&(C+=o.data[M]*s.data[M],q=!0),v[M]<=V&&F<=p[M]){var B=o.data[M]/t.data[M];g+=r.data[M]*B,x+=o.data[M]*B,q=!0}!0===q&&y.unset(M+1),W=N.next()}}0==w.length&&(I=(g+C-i)/x)}var L=function(i){for(var e=n.zeros(c,1),u=0;u<c;++u){var l;I<=v[u]?l=s.data[u]:v[u]<=I&&I<=p[u]?l=(r.data[u]-I*o.data[u])/t.data[u]:p[u]<=I&&(l=a.data[u]),e.data[u]=l}return e}(),U=.5*n.vectorDotProduct(L,n.elementwiseProduct(L,t))-n.vectorDotProduct(r,L);return!0===m?[L,U,I]:[L,U]}function F(t,r,o,i,e,s,u){void 0===u&&(u={});var f=u.eps;null==f&&(f=1e-4);var h=u.maxIter;null==h&&(h=1e4);var m=u.antiCycling;null==m&&(m=!1);var c=u.x0;if(!(t instanceof n&&t.isSquare()))throw new Error("first input must be a square matrix");if(!(r instanceof n&&r.isVector()))throw new Error("second input must be a vector");if(!(o instanceof n&&o.isVector()))throw new Error("third input must be a vector");if(!(e instanceof n&&e.isVector()))throw new Error("fifth input must be a vector");if(!(s instanceof n&&s.isVector()))throw new Error("sixth input must be a vector");if(t.nbRows!==r.nbRows)throw new Error("first and second inputs number of rows do not match: "+t.nbRows+"-"+a.nbRows);if(t.nbRows!==o.nbRows)throw new Error("first and third inputs number of rows do not match: "+t.nbRows+"-"+o.nbRows);if(t.nbRows!==e.nbRows)throw new Error("first and fifth inputs number of rows do not match: "+t.nbRows+"-"+e.nbRows);if(t.nbRows!==s.nbRows)throw new Error("first and sixth inputs number of rows do not match: "+t.nbRows+"-"+s.nbRows);var d,w=t.nbRows;if(null==c){var p=n.fill(w,1,(function(t,r){return i/w*1/o.data[t-1]}));d=V(n.ones(w,1),p,o,i,e,s)[0]}else d=new n(c);for(var v=n.xpy(n.xy(t,d),r),b=1==m?new l(w,void 0,!0):void 0,y=0;;){if(-1!==h&&y>=h)throw new Error("maximum number of iterations reached: "+h);++y;var g,x=-1,C=-1/0,R=-1,E=1/0;1==m&&(g=b.next());for(var M=0;M<w;++M){var A=M;1==m&&(A=g[M]-1),F_i=v.data[A]/o.data[A],e.data[A]<d.data[A]&&d.data[A]<s.data[A]?(F_i>C&&(C=F_i,x=A),F_i<E&&(E=F_i,R=A)):d.data[A]==e.data[A]?F_i<E&&(E=F_i,R=A):d.data[A]==s.data[A]&&F_i>C&&(C=F_i,x=A)}if(C-E<=f)break;A=R,M=x;var P,z=(e.data[A]-d.data[A])*o.data[A],k=(d.data[M]-s.data[M])*o.data[M],_=z>=k?z:k,I=(s.data[A]-d.data[A])*o.data[A],F=(d.data[M]-e.data[M])*o.data[M],O=I<=F?I:F,T=E-C,S=t.data[A*t.nbColumns+A]/(o.data[A]*o.data[A])+t.data[M*t.nbColumns+M]/(o.data[M]*o.data[M])-2*t.data[A*t.nbColumns+M]/(o.data[A]*o.data[M]);if(S>0)(P=-T/S)>O?P=O:P<_&&(P=_);else{if(0!=S)throw new Error("internal error: the input matrix might not be positive semi-definite");P=T>0?_:O}var N=d.data[A],W=d.data[M],q=P/o.data[A],B=-P/o.data[M];d.data[A]+=q,d.data[M]+=B,P==_&&(_==z&&(d.data[A]=e.data[A],q=d.data[A]-N),_==k&&(d.data[M]=s.data[M],B=d.data[M]-W)),P==O&&(O==I&&(d.data[A]=s.data[A],q=d.data[A]-N),O==F&&(d.data[M]=e.data[M],B=d.data[M]-W));for(var L=0;L<w;++L)v.data[L]=v.data[L]+t.data[L*t.nbColumns+A]*q+t.data[L*t.nbColumns+M]*B}return[d,.5*n.vectorDotProduct(d,n.xy(t,d))+n.vectorDotProduct(r,d)]}function O(t,r,o){var i=(t=new n(t)).nbRows;r=r?new n(r):n.zeros(i,1),o=o?new n(o):n.ones(i,1);N(i,r.toArray(),o.toArray());for(var e="function"==typeof Uint32Array?new Uint32Array(i):new Array(i),a=0;a<i;++a)e[a]=a+1;e.sort((function(r,n){return t.getValue(r,1)-t.getValue(n,1)}));for(var s=new n(r),u=1-s.sum(),l=-1,f=0;f<i&&!(Math.abs(u)<=1e-16);++f){l=e[f];var h=s.getValue(l,1);u>=o.getValue(l,1)-h?(s.setValue(l,1,o.getValue(l,1)),u-=o.getValue(l,1)-h):(s.setValue(l,1,h+u),u=0)}return[s.toArray(),n.vectorDotProduct(t,s)]}function T(t,r,n){var o=t.length;N(o,r,n);for(var i=0,e=0;e<o;++e){var a=0;r&&(a=r[e]);var s=1;n&&(s=n[e]);var u=t[e];if(u<a||u>s)return Number.POSITIVE_INFINITY;i+=u}return Math.abs(i-1)>1e-12?Number.POSITIVE_INFINITY:0}function S(t,r,n){for(var o=0,i=0,e=0;e<t;++e){var a=0;r&&(a=r[e]);var s=1;if(n&&(s=n[e]),a>s)throw new Error("infeasible problem detected: lower bound strictly greater than upper bound");if(a<0)throw new Error("incorrect problem detected: lower bound strictly lower than 0");if(s>1)throw new Error("incorrect problem detected: upper bound strictly greater than 1");o+=a,i+=s}if(o>1)throw new Error("infeasible problem detected: the restricted simplex is empty");return[o,i]}function N(t,r,n){for(var o=0,i=0,e=0;e<t;++e){var a=0;r&&(a=r[e]);var s=1;if(n&&(s=n[e]),a>s)throw new Error("infeasible problem detected: lower bound strictly greater than upper bound");if(a<0)throw new Error("incorrect problem detected: lower bound strictly lower than 0");if(s>1)throw new Error("incorrect problem detected: upper bound strictly greater than 1");o+=a,i+=s}if(o>1||i<1)throw new Error("infeasible problem detected: the restricted simplex is empty");return[o,i]}function W(t,r,o){var i=t.length;N(i,r,o);for(var e=n.ones(i,1),a=new n(t),s=n.ones(i,1),u=r?new n(r):n.zeros(i,1),l=o?new n(o):n.ones(i,1),f=V(e,a,s,1,u,l),h=f[0].toArray();T(h,r,o)==Number.POSITIVE_INFINITY;)h=(f=V(e,a=new n(h),s,1,u,l))[0].toArray();return h}function q(t,r,n){this.n=t,this.k=r,this.reuseOutputArray=n,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.compositionIterator=new u(r,t,!0),this.sample=function(){var t=this.compositionIterator.next();if(-1==t)return-1;for(var r=0;r<this.n;++r)this.x[r]=t[r]/this.k;return this.reuseOutputArray?this.x:this.x.slice(0)}}function B(t,r,n,o){if(this.n=t,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.u="function"==typeof Float64Array?new Float64Array(t-1):new Array(t-1),this.randomGenerator=function(t){for(var r=0;r<this.n;++r)t[r]=Math.random()},o){if("function"!=typeof o)throw new Error("the random number generator must be a function");this.randomGenerator=o}if(r&&(this.lowerBounds=r,!n)){this.upperBounds="function"==typeof Float64Array?new Float64Array(t):new Array(t);for(var i=0;i<this.n;++i)this.upperBounds[i]=1}if(n&&(this.upperBounds=n,!r)){this.lowerBounds="function"==typeof Float64Array?new Float64Array(t):new Array(t);for(i=0;i<this.n;++i)this.lowerBounds[i]=0}if(this.lowerBounds||this.upperBounds){var e=N(t,this.lowerBounds,this.upperBounds);if(this.sumLowerBounds=e[0],this.sumUpperBounds=e[1],1==this.sumLowerBounds||1==this.sumUpperBounds);else{var a=0,s=0;for(i=0;i<this.n;++i){var u=this.lowerBounds[i],l=this.upperBounds[i],f=Math.max(u,l+1-this.sumUpperBounds),h=Math.min(l,u+1-this.sumLowerBounds);this.lowerBounds[i]=f,this.upperBounds[i]=h,a+=f,s+=h}this.sumLowerBounds=a,this.sumUpperBounds=s,this.upperStarBounds="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.runningSumUpperStarBounds="function"==typeof Float64Array?new Float64Array(t):new Array(t);var m=0;for(i=0;i<this.n;++i)this.upperStarBounds[i]=(this.upperBounds[i]-this.lowerBounds[i])/(1-this.sumLowerBounds),m+=this.upperStarBounds[i],this.runningSumUpperStarBounds[i]=m}}this.sample_no_bounds=function(){for(var t=0,r=0;r<this.n;++r){var n=1-Math.random(),o=Math.log(n);this.x[r]=o,t+=o}for(r=0;r<this.n;++r)this.x[r]=this.x[r]/t;return this.x.slice(0)},this.sample_binding_bounds=function(){var t=null;if(1==this.sumLowerBounds)t=this.lowerBounds;else{if(1!=this.sumUpperBounds)throw new Error("internal error");t=this.upperBounds}for(var r=0;r<this.n;++r)this.x[r]=t[r];return this.x.slice(0)},this.sample_with_bounds=function(){this.randomGenerator(this.u);for(var r=this.u,n=1,o=t;o>=2;--o){if(Math.abs(n)<=1e-14){for(var i=o;i>=1;--i)this.x[i-1]=0;break}var e=r[o-2],a=Math.max(0,1-this.runningSumUpperStarBounds[o-2]/n),s=Math.min(1,this.upperStarBounds[o-1]/n),u=n*(1-Math.pow(e*Math.pow(1-s,o-1)+(1-e)*Math.pow(1-a,o-1),1/(o-1)));this.x[o-1]=u,n-=u}1==o&&(this.x[0]=n);for(var l=0;l<this.n;++l)this.x[l]=(1-this.sumLowerBounds)*this.x[l]+this.lowerBounds[l];return this.x.slice(0)},this.lowerBounds||this.upperBounds?1==this.sumLowerBounds||1==this.sumUpperBounds?this.sample=this.sample_binding_bounds:this.sample=this.sample_with_bounds:this.sample=this.sample_no_bounds}function L(t,r,o){if(G.call(this,t,r,o),this.cornerPortfolios=function(t,r,o,i,a,s){function u(t){this.STATUS_UNDEF=-1,this.STATUS_IN=0,this.STATUS_LOW=1,this.STATUS_UP=2,this.nbAssets=t,this.varIn=new e,this.varIn.resize(t),this.varLow=new e,this.varLow.resize(t),this.varUp=new e,this.varUp.resize(t),this.setIn=function(t){this.varIn.set(t),this.varLow.unset(t),this.varUp.unset(t)},this.setOnLowerBound=function(t){this.varLow.set(t),this.varIn.unset(t),this.varUp.unset(t)},this.setOnUpperBound=function(t){this.varUp.set(t),this.varIn.unset(t),this.varLow.unset(t)},this.isIn=function(t){return this.varIn.get(t)},this.isOnLowerBound=function(t){return this.varLow.get(t)},this.isOnUpperBound=function(t){return this.varUp.get(t)},this.isOut=function(t){return this.varLow.get(t)||this.varUp.get(t)},this.getInIndexes=function(){return this.varIn.toArray()},this.getOutIndexes=function(){return this.varLow.toArray().concat(this.varUp.toArray())}}function l(t,r,o,i,e){for(var a=r.nbRows,s="function"==typeof Uint32Array?new Uint32Array(a):new Array(a),l=0;l<a;++l)s[l]=l+1;s.sort((function(r,n){return t.getValue(n,1)-t.getValue(r,1)}));for(var f,h=!0,m=1;m<a;++m)if(t.getValue(s[m],1)==t.getValue(s[m-1],1)){h=!1;break}1==h?f=new n(O(t.elemMap((function(t,r,n){return-n})),o,i)[0]):f=new U(t,r,{optimizationMethodParams:{antiCyclingGsmo:!0,maximumRiskToleranceValueOnlyGsmo:!0,maxIterGsmo:-1},constraints:{minWeights:o,maxWeights:i}}).getHighestReturnPortfolio();var c=0,d=0,w=0,p=new u(a);for(m=1;m<=a;++m)Math.abs(f.getValue(m,1)-o.getValue(m,1))<=e?(p.setOnLowerBound(m),++d):Math.abs(f.getValue(m,1)-i.getValue(m,1))<=e&&i.getValue(m,1)<1-e?(p.setOnUpperBound(m),++w):(p.setIn(m),++c);return{weights:f,variablesStatusManager:p,nbAssetsLow:d,nbAssetsIn:c,nbAssetsUp:w}}void 0===s&&(s={constraints:{}});void 0===s.optimizationMethodParams&&(s.optimizationMethodParams={});var f=s.optimizationMethodParams.maxIterCriticalLine;null==f&&(f=1e3);var h=r.nbColumns,m=o,c=i,d=[],w=n.ones(1,h),p=w.nbRows,v=n.ones(1,1),b=n.fill(h,h+p,(function(t,n){return n<=h?r.data[(t-1)*r.nbColumns+(n-1)]:w.data[(n-h-1)*w.nbColumns+(t-1)]})),y=l(t,r,m,c,a),g=y.weights,x=y.variablesStatusManager;if(y.nbAssetsLow==h||y.nbAssetsUp==h){var C=new n(g);return d.push([C,0]),d}if(0==y.nbAssetsIn){var R=c.elemMap((function(t,r,n){return Math.min(n+1e-8,1)})),E=l(t,r,m,R,a);if(x=E.variablesStatusManager,0==E.nbAssetsIn)throw new Error("internal error: impossible to determine the IN variables associated to the maximum return portfolio")}var M=0;for(;;){if(-1!==f&&M>=f)throw new Error("maximum number of iterations reached: "+f);++M;var A=x.getInIndexes(),P=x.getOutIndexes(),z=n.fill(h+p,h+p,(function(t,n){return t<=h&&n<=h?x.isIn(t)?r.data[(t-1)*r.nbColumns+(n-1)]:t==n?1:0:t>=h+1&&n<=h?x.isIn(n)?w.data[(t-h-1)*w.nbColumns+(n-1)]:0:t<=h&&n>=h+1&&x.isIn(t)?w.data[(n-h-1)*w.nbColumns+(t-1)]:0})),k=n.fill(h,1,(function(t,r){return x.isOnUpperBound(t)?c.data[t-1]:x.isOnLowerBound(t)?m.data[t-1]:0})),_=n.xy(w,k),I=n.fill(h+p,1,(function(t,r){return t<=h?k.data[t-1]:v.data[t-h-1]-_.data[t-h-1]})),V=t.elemMap((function(t,r,n){return x.isIn(t)?n:0})),F=n.fill(h+p,1,(function(t,r){return t<=h?V.data[t-1]:0}));try{var T=n.luDecomposition(z),S=(T.lowerTriangular,T.upperTriangular,T.rowPermutation,T.columnPermutation,n.linsolveForwardSubstitution(T.lowerTriangular,n.xy(T.rowPermutation,I))),N=n.linsolveBackSubstitution(T.upperTriangular,S),W=n.xy(T.columnPermutation,N);S=n.linsolveForwardSubstitution(T.lowerTriangular,n.xy(T.rowPermutation,F)),N=n.linsolveBackSubstitution(T.upperTriangular,S);var q=n.xy(T.columnPermutation,N)}catch(et){throw new Error("internal error: impossible to solve the KKT system")}for(var B=n.xy(b,W),L=n.xmy(n.xy(b,q),t),D=-1,G=0,H=x.STATUS_UNDEF,j=1;j<=A.length;++j){var Y=A[j-1],K=W.data[Y-1],J=q.data[Y-1];if(J>1e-8){var X=m.data[Y-1];(Z=(X-K)/J)>=G&&(D=Y,G=Z,H=x.STATUS_LOW)}else if(J<-1e-8){var Z,Q=c.data[Y-1];(Z=(Q-K)/J)>=G&&(D=Y,G=Z,H=x.STATUS_UP)}}var $=-1,tt=0;for(j=1;j<=P.length;++j){var rt=P[j-1],nt=B.data[rt-1],ot=L.data[rt-1];if(x.isOnLowerBound(rt)){if(ot>1e-8)(it=-nt/ot)>=tt&&($=rt,tt=it)}else{if(!x.isOnUpperBound(rt))throw new Error("internal error: OUT variable neither on its lower of upper bound");var it;ot<-1e-8&&(it=-nt/ot)>=tt&&($=rt,tt=it)}}lambda_e=Math.max(G,tt,0);C=n.fill(h,1,(function(t,r){if(t<=h){var n=W.data[t-1]+lambda_e*q.data[t-1],o=m.data[t-1],i=c.data[t-1];return Math.max(Math.min(n,i),o)}}));if(d.push([C,lambda_e]),lambda_e<1e-8)break;G>=tt?H==x.STATUS_LOW?x.setOnLowerBound(D):x.setOnUpperBound(D):x.setIn($)}return d}(this.mu,this.sigma,this.lowerBounds,this.upperBounds,this.epsBounds,o),0==this.cornerPortfolios.length)throw new Error("internal error: no corner portfolio could be computed")}function U(t,r,o){if(G.call(this,t,r,o),void 0===o&&(o={constraints:{}}),void 0===o.optimizationMethodParams&&(o.optimizationMethodParams={}),this.epsGsmo=o.optimizationMethodParams.epsGsmo,null==this.epsGsmo&&(this.epsGsmo=1e-6),this.maxIterationsGsmo=o.optimizationMethodParams.maxIterGsmo,null==this.maxIterationsGsmo&&(this.maxIterationsGsmo=1e4),this.antiCyclingGsmo=o.optimizationMethodParams.antiCyclingGsmo,null==this.antiCyclingGsmo&&(this.antiCyclingGsmo=!1),this.maximumRiskToleranceValueOnly=o.optimizationMethodParams.maximumRiskToleranceValueOnlyGsmo,null==this.maximumRiskToleranceValueOnly&&(this.maximumRiskToleranceValueOnly=!1),this.minimumRiskToleranceValueOnly=o.optimizationMethodParams.minimumRiskToleranceValueOnlyGsmo,null==this.minimumRiskToleranceValueOnly&&(this.minimumRiskToleranceValueOnly=!1),1==this.maximumRiskToleranceValueOnly&&1==this.minimumRiskToleranceValueOnly)throw new Error("internal error: inconsistent minimum/maximum risk tolerance values computation");if(this.cachedEfficientPortfolios=new Map,0==this.minimumRiskToleranceValueOnly){var i=function(){var t,r=this.nbAssets,o=this.mu,i=this.sigma,e=this.lowerBounds,a=this.upperBounds,s=-O(o.elemMap((function(t,r,n){return-n})),e,a)[1],u=i,l=n.ones(r,1),f=e,h=a,m=n.fill(r,1,(function(t,n){return 1/r})),c=V(n.ones(r,1),m,l,1,f,h)[0],d=0,w=32;do{if(++d>54)throw new Error("internal error: maximum number of iterations reached when searching for the efficient portfolio with maximum return");w*=2;var p=n.ax(-w,o),v=F(u,p,l,1,f,h,{x0:c,antiCycling:this.antiCyclingGsmo,eps:this.epsGsmo,maxIter:this.maxIterationsGsmo});t=v[0];var b=this.computePortfolioReturn(t);this.cachedEfficientPortfolios.set(w,{weights:t,ret:b,volatility:this.computePortfolioVolatility(t)})}while(Math.abs(b-s)>1e-12);return[t,w]}.call(this);this.highestRiskTolerance=i[1],this.highestRiskTolerancePortfolio=i[0],this.cachedEfficientPortfolios.set(this.highestRiskTolerance,{weights:this.highestRiskTolerancePortfolio,ret:this.getHighestReturn(),volatility:this.getHighestVolatility()})}if(0==this.maximumRiskToleranceValueOnly){var e=function(){var t,r=this.nbAssets,o=this.mu,i=this.sigma,e=this.lowerBounds,a=this.upperBounds,s=i,u=n.zeros(r,1),l=n.ones(r,1),f=e,h=a,m=n.fill(r,1,(function(t,n){return 1/r})),c=V(n.ones(r,1),m,l,1,f,h)[0],d=F(s,u,l,1,f,h,{x0:c,antiCycling:this.antiCyclingGsmo,eps:this.epsGsmo,maxIter:this.maxIterationsGsmo}),w=this.computePortfolioVolatility(d[0]),p=2;do{p/=2;u=n.ax(-p,o);var v=F(s,u,l,1,f,h,{x0:c,antiCycling:this.antiCyclingGsmo,eps:this.epsGsmo,maxIter:this.maxIterationsGsmo});t=v[0];var b=this.computePortfolioVolatility(t);this.cachedEfficientPortfolios.set(p,{weights:t,ret:this.computePortfolioReturn(t),volatility:b})}while(Math.abs(b-w)>1e-12);return[t,p]}.call(this);this.lowestRiskTolerance=e[1],this.lowestRiskTolerancePortfolio=e[0],this.cachedEfficientPortfolios.set(this.lowestRiskTolerance,{weights:this.lowestRiskTolerancePortfolio,ret:this.getLowestReturn(),volatility:this.getLowestVolatility()})}}function D(t,r,n){this.efficientFrontier=null;try{this.efficientFrontier=new L(t,r,n),this.efficientFrontierOptimizationMethod="critical-line"}catch(o){if("internal error: impossible to solve the KKT system"!=o.message)throw o;this.efficientFrontier=new U(t,r,n),this.efficientFrontierOptimizationMethod="gsmo"}this.epsPortfolioVolatility=this.efficientFrontier.epsPortfolioVolatility,this.epsEfficientPortfolioComputation=this.efficientFrontier.epsEfficientPortfolioComputation,this.mu=this.efficientFrontier.mu,this.sigma=this.efficientFrontier.sigma,this.nbAssets=this.efficientFrontier.mu.nbRows,this.lowerBounds=this.efficientFrontier.lowerBounds,this.upperBounds=this.efficientFrontier.upperBounds}function G(t,r,o){void 0===o&&(o={constraints:{}}),void 0===o.constraints&&(o.constraints={}),this.epsBounds=1e-14,this.epsPortfolioVolatility=1e-14,this.epsEfficientPortfolioComputation=1e-10,this.mu=new n(t),this.sigma=new n(r),this.nbAssets=this.sigma.nbRows,this.lowerBounds=null==o.constraints.minWeights?n.zeros(this.nbAssets,1):new n(o.constraints.minWeights),this.upperBounds=null==o.constraints.maxWeights?n.ones(this.nbAssets,1):new n(o.constraints.maxWeights);for(var i=1;i<=this.nbAssets;++i){var e=this.lowerBounds.getValue(i,1),a=this.upperBounds.getValue(i,1);e==a&&(this.lowerBounds.setValueAt(i,1,Math.max(0,e-this.epsBounds)),this.upperBounds.setValueAt(i,1,Math.min(1,a+this.epsBounds)))}N(this.nbAssets,this.lowerBounds.toArray(),this.upperBounds.toArray())}return t.randomCorrelationMatrix=function(t,r){return n.randomCorrelation(t,r)},t.nearestCorrelationMatrix=function(t,r){function o(t){if(!t.isSymmetric(e))throw new Error("internal error: input matrix must be symmetric");return t.unitDiagonalize()}function i(t,r){if(!t.isSymmetric(e))throw new Error("internal error: input matrix must be symmetric");var o=n.eig(t,{maxIter:-1,epsSymmetric:e}),i=o[0],a=o[1].elemMap((function(t,n,o){return Math.max(r,o)})),s=n.axty(1,n.elementwiseProduct(i,a.transpose()),i);return s=s.symmetrize({inPlace:!0})}t=new n(t);void 0===r&&(r={});var e=r.epsSymmetric;null==e&&(e=1e-12);var a=r.eps;null==a&&(a=1e-6);var s=r.maxIter;null==s&&(s=100);var u=r.minEigenvalue;if(null==u&&(u=1e-8),!t.isSymmetric(e))throw new Error("input matrix must be symmetric");for(var l=t.nbRows,f=n.copy(t),h=n.copy(t),m=n.zeros(l,l),c=Number.POSITIVE_INFINITY,d=Number.POSITIVE_INFINITY,w=Number.POSITIVE_INFINITY,p=0;;){if(-1!==s&&p>=s)throw new Error("maximum number of iterations reached: "+s);++p;var v=n.xmy(h,m),b=i(v,u),y=n.xmy(b,v),g=o(b);if(c=n.xmy(b,f).vectorNorm("infinity")/f.vectorNorm("infinity"),d=n.xmy(g,h).vectorNorm("infinity")/h.vectorNorm("infinity"),w=n.xmy(g,b).vectorNorm("infinity")/g.vectorNorm("infinity"),f=b,h=g,m=y,0==a){if(h.isCorrelationMatrix())break}else if(Math.max(c,d,w)<=a)break}if(0==a)return h;var x=f.diagonal().elemMap((function(t,r,n){return 1/Math.sqrt(n)}));return n.elementwiseProduct(n.elementwiseProduct(f,x),x.transpose()).symmetrize({inPlace:!0}).unitDiagonalize({inPlace:!0})},t.repairCorrelationMatrix=function(r,o){void 0===o&&(o={});var i=o.method;void 0===i&&(i="nearest-correlation-matrix");var e=o.minEigenvalue;null==e&&(e=0);var a=o.epsNcm;null==a&&(a=1e-6);var s=o.epsCorrMat;null==s&&(s=1e-12);var u=o.shrinkageTarget;if("spectral"!=i&&"linear-shrinkage"!=i&&"nearest-correlation-matrix"!=i)throw new Error("unsupported correlation matrix repair method");if(!(r=new n(r)).isSymmetric(s))throw new Error("input matrix must be symmetric");if(!r.isUnitDiagonal(s))throw new Error("input matrix must be unit diagonal");if(e<0||e>1)throw new Error("lower bound on the smallest eigenvalue(s) of the correlation matrix must belong to interval [0,1]");var l,f=r.nbRows;if((p=n.eig(r,{maxIter:-1,epsSymmetric:s,sortedEigenvalues:!0}))[1].data[f-1]>=e)return r;if("spectral"==i){if(e>0)throw new Error("spectral correlation matrix repair is not compatible with a minimum eigenvalue");var h=p[0],m=p[1].elemMap((function(t,r,n){return Math.sqrt(Math.max(0,n))})),c=n.elementwiseProduct(h,m.transpose()),d=n.fill(f,1,(function(t,r){return 1/c.vectorNorm("two","row",t)})),w=n.elementwiseProduct(c,d);l=(l=n.axty(1,w,w)).unitDiagonalize()}else if("linear-shrinkage"==i){if(null==u)u=n.identity(f);else{if(!(u=new n(u)).isCorrelationMatrix(s))throw new Error("shrinkage target matrix must be a correlation matrix");var p;if((p=n.eig(u,{maxIter:-1,epsSymmetric:s,sortedEigenvalues:!0}))[1].data[f-1]<e)throw new Error("smallest eigenvalue of the shrinkage target matrix strictly lower than the desired lower bound on the smallest eigenvalue(s) of the correlation matrix")}var v=r,b=u,y=_((function(t){var r=n.axpby(t,b,1-t,v);return n.eig(r,{maxIter:-1,epsSymmetric:s,sortedEigenvalues:!0})[1].data[f-1]-e}),0,1,{outputInterval:!0})[1];l=(l=n.axpby(y,b,1-y,v)).symmetrize().unitDiagonalize()}else{if("nearest-correlation-matrix"!=i)throw new Error("internal error: unsupported repair method");l=t.nearestCorrelationMatrix(r,{maxIter:-1,eps:a,minEigenvalue:e})}return l},t.perturbedCorrelationMatrix=function(r,o){void 0===(o=o)&&(o={}),void 0===o.method&&(o.method="additive-noise");var i=o.epsCorrMat;null==i&&(i=1e-12);var e=o.epsNcm;null==e&&(e=1e-6);var a=o.sigma;null==a&&(a=.05);var s=o.noiseLevelMax;null==s&&(s=.01);var u=o.noiseSpaceDimension;null==u&&(u=3);var l=o.method;if("spectral-noise"!=l&&"multiplicative-noise"!=l&&"additive-noise"!=l)throw new Error("unsupported perturbation method");if(!(r=new n(r)).isCorrelationMatrix(i))throw new Error("input matrix must be symmetric, unit diagonal and positive semidefinite");var f,h=r.nbRows;if("spectral-noise"==l){var m=n.eig(r,{maxIter:-1,epsSymmetric:i,sortedEigenvalues:!0}),c=m[0],d=m[1].elemMap((function(t,r,n){return n*Math.exp(a*M(0,1))})),w=n.axty(1,n.elementwiseProduct(c,d.transpose()),c);f=(f=w.elemMap((function(t,r,n){return n/Math.sqrt(w.data[(t-1)*w.nbColumns+(t-1)]*w.data[(r-1)*w.nbColumns+(r-1)])}))).symmetrize().unitDiagonalize()}else if("multiplicative-noise"==l)(f=n.fillSymmetric(h,(function(t,n){return t==n?1:Math.max(-1,Math.min(1,r.data[(t-1)*r.nbColumns+(n-1)]*(1+a*M(0,1))))}))).isCorrelationMatrix()||(f=t.nearestCorrelationMatrix(f,{maxIter:-1,eps:e}));else{if("additive-noise"!=l)throw new Error("internal error: unsupported perturbation method");for(var p=new A(u,!0),v=new Array(h),b=0;b<h;++b)v[b]=new n(p.sample());(f=n.fillSymmetric(h,(function(t,o){if(t==o)return 1;var i=r.data[(t-1)*r.nbColumns+(o-1)],e=s*n.vectorDotProduct(v[t-1],v[o-1]);return Math.max(-1,Math.min(1,i+e))}))).isCorrelationMatrix()||(f=t.nearestCorrelationMatrix(f,{maxIter:-1,eps:e}))}return f},t.covarianceMatrixFromCovarianceMatrix=function(t){return r(t=new n(t)),t},t.covarianceMatrixFromCorrelationMatrix=function(t,o,i){void 0===(i=i)&&(i={}),void 0===i.diagonalVectorType&&(i.diagonalVectorType="variances");var e=i.diagonalVectorType;if("variances"!=e&&"standard-deviations"!=e)throw new Error("unsupported diagonal vector type");t=new n(t),o=new n(o);if(t.nbRows!=o.nbRows||t.nbColumns!=o.nbRows)throw new Error("input correlation matrix dimensions not compatible with input diagonal vector dimension");var a;t.nbRows;if("variances"==e)a=o.elemMap((function(t,r,n){return Math.sqrt(n)}));else{if("standard-deviations"!=e)throw new Error("internal error: unsupported diagonal vector type");a=o}var s=n.elementwiseProduct(n.elementwiseProduct(t,a),a.transpose());return r(s=s.symmetrize()),s},t.covarianceMatrix=function(t,i){void 0===(i=i)&&(i={}),void 0===i.method&&(i.method="covariance");var e=i.assumeZeroMean;null==e&&(e=!0);var a=i.regularizationMethod;if(null==a&&(a="none"),"none"!=a&&"linear-shrinkage"!=a)throw new Error("unsupported covariance matrix regularization method");var s=i.shrinkageTarget;if("linear-shrinkage"==a&&-1==["constant-variance-null-correlation","constant-variance-correlation","null-correlation","constant-correlation"].indexOf(s))throw new Error("unsupported covariance matrix shrinkage target");for(var u,l=t.length,f=t[0].length,h=0;h<l;++h)if(t[h].length!=f)throw new Error("inconsistent input matrix dimensions");if("none"==a){var m=P;0==e&&(m=z),u=o(l,l);for(h=0;h<u.nbRows;++h){for(var c=0;c<h;++c)u.data[h*u.nbColumns+c]=u.data[c*u.nbColumns+h];for(c=h;c<u.nbColumns;++c)u.data[h*u.nbColumns+c]=m(t[h],t[c])}}else{if("linear-shrinkage"!=a)throw new Error("internal error: unsupported covariance matrix regularization method");var d,w,p,v=n.fill(l,1,(function(r,n){return x(t[r-1])})),b=n.fill(l,f,(function(r,n){return t[r-1][n-1]-v.data[r-1]})),y=(d=1==e?n.axty(1/f,b,b).toCovarianceMatrix():n.axty(1/(f-1),b,b).toCovarianceMatrix()).getStandardDeviations(),g=d.getCorrelationMatrix();if("constant-variance-null-correlation"==s){var C=d.trace()/l;w=n.fill(l,l,(function(t,r){return t==r?C:0}))}else if("constant-variance-correlation"==s){var R=d.trace()/l,E=0;for(h=0;h<l-1;++h)for(c=h+1;c<l;++c)E+=d.data[h*d.nbColumns+c];E*=2/(l*(l-1)),w=n.fill(l,l,(function(t,r){return t==r?R:E}))}else if("null-correlation"==s)w=n.fill(l,l,(function(t,r){return t==r?y.data[t-1]*y.data[t-1]:0}));else if("constant-correlation"==s){p=0;for(h=0;h<l-1;++h)for(c=h+1;c<l;++c)p+=g.data[h*g.nbColumns+c];p*=2/(l*(l-1)),w=n.fill(l,l,(function(t,r){return t==r?y.data[t-1]*y.data[t-1]:p*y.data[t-1]*y.data[r-1]}))}var M,A=n.fill(l,l,(function(r,n){for(var o=0,i=0;i<f;++i)o+=Math.pow((t[r-1][i]-v.data[r-1])*(t[n-1][i]-v.data[n-1])-d.data[(r-1)*d.nbColumns+(n-1)],2);return o/=1==e?f:f-1})),k=A.sum();if("constant-variance-null-correlation"==s)M=0;else if("constant-variance-correlation"==s)M=0;else if("null-correlation"==s)M=A.trace();else if("constant-correlation"==s){M=0;for(h=1;h<=l;++h)for(c=1;c<=l;++c)if(h!=c){for(var _=0,I=0;I<f;++I)_+=(Math.pow(t[h-1][I]-v.data[h-1],2)-d.data[(h-1)*d.nbColumns+(h-1)])*((t[h-1][I]-v.data[h-1])*(t[c-1][I]-v.data[c-1])-d.data[(h-1)*d.nbColumns+(c-1)]);_/=1==e?f:f-1;var V=0;for(I=0;I<f;++I)V+=(Math.pow(t[c-1][I]-v.data[c-1],2)-d.data[(c-1)*d.nbColumns+(c-1)])*((t[h-1][I]-v.data[h-1])*(t[c-1][I]-v.data[c-1])-d.data[(h-1)*d.nbColumns+(c-1)]);V/=1==e?f:f-1,M+=y.data[c-1]/y.data[h-1]*_+y.data[h-1]/y.data[c-1]*V}M*=p/2,M+=A.trace()}var F,O=(k-M)/Math.pow(n.xmy(d,w).matrixNorm("frobenius"),2);F=1==e?Math.max(0,Math.min(1,O/f)):Math.max(0,Math.min(1,O/(f-1))),u=n.axpby(F,w,1-F,d)}return r(u),u},n.prototype={constructor:n,toString:function(){for(var t=0,r=0;r<this.nbRows;++r)for(var n=0;n<this.nbColumns;++n){var o=String(this.data[r*this.nbColumns+n]).length;o>t&&(t=o)}var i=[];for(r=0;r<this.nbRows;++r){i.push("[ ");for(n=0;n<this.nbColumns;++n){var e=String(this.data[r*this.nbColumns+n]);i.push(new Array(t-e.length+1).join(" ")+e+" ")}i.push("]\n")}return i.join("")},toRowArray:function(t){t=t||function(t,r,n){return!0};for(var r=new Array(this.nbRows),n=0;n<this.nbRows;++n){r[n]=new Array(this.nbColumns);for(var o=0,i=0;i<this.nbColumns;++i){var e=this.data[n*this.nbColumns+i];t(n+1,i+1,e)&&(r[n][o++]=e)}r[n].length=o}return r},toArray:function(t){t=t||function(t,r,n){return!0};for(var r=new Array(this.nbRows*this.nbColumns),n=0,o=0;o<this.nbRows;++o)for(var i=0;i<this.nbColumns;++i){var e=this.data[o*this.nbColumns+i];t(o+1,i+1,e)&&(r[n++]=e)}return r.length=n,r},setValueAt:function(t,r,n){if(t<1||r<1||t>this.nbRows||r>this.nbColumns)throw new Error("index out of bounds when setting matrix value, ("+t+","+r+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(t-1)*this.nbColumns+(r-1)]=n,this},setValue:function(t,r,n){return this.data[(t-1)*this.nbColumns+(r-1)]=n,this},getValueAt:function(t,r){if(t<1||r<1||t>this.nbRows||r>this.nbColumns)throw new Error("index out of bounds when getting matrix value, ("+t+","+r+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(t-1)*this.nbColumns+(r-1)]},getValue:function(t,r){return this.data[(t-1)*this.nbColumns+(r-1)]},isSquare:function(){return this.nbRows===this.nbColumns},isSymmetric:function(t){if(null==t&&(t=0),!this.isSquare())return!1;for(var r=0;r<this.nbRows;++r)for(var n=0;n<this.nbColumns;++n)if(Math.abs(this.data[r*this.nbColumns+n]-this.data[n*this.nbColumns+r])>t)return!1;return!0},isUnitDiagonal:function(t){if(null==t&&(t=0),!this.isSquare())return!1;for(var r=this.data[0],n=0;n<this.nbRows;++n){var o=this.data[n*this.nbColumns+n];o>r&&(r=o)}return!(Math.abs(r-1)>t)},isCorrelationMatrix:function(t,r){if(null==t&&(t=0),null==r&&(r="boolean"),"exception"!=r&&"boolean"!=r)throw new Error("unexpected output type");try{if(!this.isSquare())throw"not square";if(!this.isSymmetric(t))throw"not symmetric";if(!this.isUnitDiagonal(t))throw"not unit diagonal";if(n.eig(this,{maxIter:-1,sortedEigenvalues:!0})[1].data[this.nbRows-1]<0)throw"not positive semi-definite";return!0}catch(o){if("exception"==r)throw new Error(o);return!1}},isCovarianceMatrix:function(t,r){if(null==t&&(t=0),null==r&&(r="boolean"),"exception"!=r&&"boolean"!=r)throw new Error("unexpected output type");try{if(!this.isSquare())throw"not square";if(!this.isSymmetric(t))throw"not symmetric";for(var o=this.data[0],i=0;i<this.nbRows;++i){var e=this.data[i*this.nbColumns+i];e>o&&(o=e)}if(o<-t)throw"not positive diagonal";if(n.eig(this,{maxIter:-1,sortedEigenvalues:!0})[1].data[this.nbRows-1]<0)throw"not positive semi-definite";return!0}catch(a){if("exception"==r)throw new Error(a);return!1}},isVector:function(){return 1===this.nbColumns},isNonNegative:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(this.data[t*this.nbColumns+r]<0)return!1;return!0},isPositive:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(this.data[t*this.nbColumns+r]<=0)return!1;return!0},isNonPositive:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(this.data[t*this.nbColumns+r]>0)return!1;return!0},isNegative:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(this.data[t*this.nbColumns+r]>=0)return!1;return!0},sum:function(){for(var t=0,r=0;r<this.data.length;++r)t+=this.data[r];return t},min:function(){for(var t=Number.POSITIVE_INFINITY,r=0;r<this.data.length;++r)this.data[r]<t&&(t=this.data[r]);return t},max:function(){for(var t=Number.NEGATIVE_INFINITY,r=0;r<this.data.length;++r)this.data[r]>t&&(t=this.data[r]);return t},normalize:function(t){var r=o(this.nbRows,this.nbColumns,t),n=this.sum();if(0===n)throw new Error("sum of coefficients of matrix is null");for(var i=0;i<this.data.length;++i)r.data[i]=this.data[i]/n;return r},diagonal:function(t){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var r=o(this.nbRows,1,t),n=0;n<this.nbRows;++n)r.data[n]=this.data[n*(this.nbColumns+1)];return r},row:function(t,r){if(t<1||t>this.nbRows)throw new Error("index out of bounds when getting matrix row, ("+t+") in size ("+this.nbRows+","+this.nbColumns+")");for(var n=o(this.nbColumns,1,r),i=0;i<this.nbColumns;++i)n.data[i]=this.data[(t-1)*this.nbColumns+i];return n},column:function(t,r){if(t<1||t>this.nbColumns)throw new Error("index out of bounds when getting matrix column, ("+t+") in size ("+this.nbRows+","+this.nbColumns+")");for(var n=o(this.nbRows,1,r),i=0;i<this.nbRows;++i)n.data[i]=this.data[i*this.nbColumns+(t-1)];return n},elemMap:function(t,r){for(var n=o(this.nbRows,this.nbColumns,r),i=0;i<n.nbRows;++i)for(var e=0;e<n.nbColumns;++e)n.data[i*n.nbColumns+e]=t(i+1,e+1,this.data[i*this.nbColumns+e]);return n},submatrix:function(t,r,n){if(!(t instanceof Array||t instanceof Uint32Array)||0==t.length)throw new Error("first parameter must be a non empty array");if(!(r instanceof Array||r instanceof Uint32Array)||0==r.length)throw new Error("second parameter must be a non empty array");for(var i=1;i<t.length;++i)if(t[i-1]>=t[i])throw new Error("first parameter must be a sorted array");for(var e=1;e<r.length;++e)if(r[e-1]>=t[e])throw new Error("second parameter must be a sorted array");var a=o(t.length,r.length,n);for(i=0;i<a.nbRows;++i){var s=t[i]-1;for(e=0;e<a.nbColumns;++e){var u=r[e]-1;a.data[i*a.nbColumns+e]=this.data[s*this.nbColumns+u]}}return a},transpose:function(t){for(var r=o(this.nbColumns,this.nbRows,t),n=0;n<r.nbRows;++n)for(var i=0;i<r.nbColumns;++i)r.data[n*r.nbColumns+i]=this.data[i*this.nbColumns+n];return r},determinant:function(){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var t=n.qrDecomposition(this,{qLess:!0}),r=1,o=0;o<t.data.length;o+=t.nbColumns+1)r*=t.data[o];return r},trace:function(){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var t=0,r=0;r<this.nbRows;++r)t+=this.data[r*this.nbColumns+r];return t},symmetrize:function(t){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");var r;r=t&&t.inPlace?this:new n(this);for(var o=1;o<=r.nbRows;++o)for(var i=o+1;i<=r.nbColumns;++i){var e=(r.data[(o-1)*r.nbColumns+(i-1)]+r.data[(i-1)*r.nbColumns+(o-1)])/2;r.data[(o-1)*r.nbColumns+(i-1)]=e,r.data[(i-1)*r.nbColumns+(o-1)]=e}return r},unitDiagonalize:function(t){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");var r;r=t&&t.inPlace?this:new n(this);for(var o=0;o<r.nbRows;++o)r.data[o*r.nbColumns+o]=1;return r},swapRows:function(t,r,o){if(!(1<=t&&t<=this.nbRows&&1<=r&&r<=this.nbRows))throw new Error("incorrect rows indexes: ("+t+","+r+")");var i;if(i=o&&o.inPlace?this:new n(this),t==r)return i;t-=1,r-=1;for(var e=0;e<i.nbColumns;++e){var a=i.data[t*i.nbColumns+e];i.data[t*i.nbColumns+e]=i.data[r*i.nbColumns+e],i.data[r*i.nbColumns+e]=a}return i},swapColumns:function(t,r,o){if(!(1<=t&&t<=this.nbColumns&&1<=r&&r<=this.nbColumns))throw new Error("incorrect columns indexes: ("+t+","+r+")");var i;if(i=o&&o.inPlace?this:new n(this),t==r)return i;t-=1,r-=1;for(var e=0;e<i.nbRows;++e){var a=i.data[e*i.nbColumns+t];i.data[e*i.nbColumns+t]=i.data[e*i.nbColumns+r],i.data[e*i.nbColumns+r]=a}return i},matrixNorm:function(t){if("one"==t){for(var r=0,n=0;n<this.nbColumns;++n){for(var o=0,i=0;i<this.nbRows;++i)o+=Math.abs(this.data[i*this.nbColumns+n]);r=Math.max(r,o)}return r}if("infinity"==t){var e=0;for(i=0;i<this.nbRows;++i){var a=0;for(n=0;n<this.nbColumns;++n)a+=Math.abs(this.data[i*this.nbColumns+n]);e=Math.max(e,a)}return e}if("frobenius"==t)return this.vectorNorm("two");throw new Error("unsupported matrix norm: "+t)},vectorNorm:function(t,r,n){var o,i,e,a;if(void 0===r||"matrix"==r)o=0,i=this.nbRows,e=0,a=this.nbColumns;else if("row"==r){if(void 0===n)throw new Error("undefined row index");if(n<1||n>this.nbRows)throw new Error("row index out of bounds: "+n);o=n-1,i=n,e=0,a=this.nbColumns}else if("column"==r){if(void 0===n)throw new Error("undefined row index");if(n<1||n>this.nbColumns)throw new Error("column index out of bounds: "+n);o=0,i=this.nbRows,e=n-1,a=n}else if(void 0!==r)throw new Error("unsupported matrix subset: "+r);if("one"==t){for(var s=0,u=o*this.nbColumns,l=o;l<i;++l){for(var f=u+e,h=e;h<a;++h)s+=Math.abs(this.data[f]),f++;u+=this.nbColumns}return s}if("two"==t){var m=0,c=1;for(u=o*this.nbColumns,l=o;l<i;++l){for(f=u+e,h=e;h<a;++h){var d=this.data[f],w=Math.abs(d);0!=w&&(w>m?(c=1+c*(m/d)*(m/d),m=w):c+=d/m*(d/m)),f++}u+=this.nbColumns}return m*Math.sqrt(c)}if("infinity"==t){var p=0;for(u=o*this.nbColumns,l=o;l<i;++l){for(f=u+e,h=e;h<a;++h)p=Math.max(p,Math.abs(this.data[f])),f++;u+=this.nbColumns}return p}throw new Error("unsupported vector norm: "+t)},toCovarianceMatrix:function(){return r(this),this}},n.areEqual=function(t,r,o){if(!(t instanceof n))throw new Error("a must be a matrix");if(!(r instanceof n))throw new Error("b must be a matrix");if(t.nbRows!==r.nbRows)return!1;if(t.nbColumns!==r.nbColumns)return!1;for(var i=t.nbRows*t.nbColumns,e=o||0,a=0;a<i;++a)if(Math.abs(t.data[a]-r.data[a])>e)return!1;return!0},n.xpy=function(t,r,i){if(!(t instanceof n))throw new Error("first input must be a matrix");if(!(r instanceof n))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbColumns||t.nbRows!==r.nbRows)throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var e=o(t.nbRows,t.nbColumns,i),a=t.nbRows*t.nbColumns,s=0;s<a;++s)e.data[s]=t.data[s]+r.data[s];return e},n.xmy=function(t,r,i){if(!(t instanceof n))throw new Error("first input must be a matrix");if(!(r instanceof n))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbColumns||t.nbRows!==r.nbRows)throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var e=o(t.nbRows,t.nbColumns,i),a=t.nbRows*t.nbColumns,s=0;s<a;++s)e.data[s]=t.data[s]-r.data[s];return e},n.axpby=function(t,r,i,e,a){if(!(r instanceof n))throw new Error("first input must be a matrix");if(!(e instanceof n))throw new Error("second input must be a matrix");if(r.nbColumns!==e.nbColumns||r.nbRows!==e.nbRows)throw new Error("input matrices sizes do not match: ("+r.nbRows+","+r.nbColumns+") - ("+e.nbRows+","+e.nbColumns+")");for(var s=o(r.nbRows,r.nbColumns,a),u=r.nbRows*r.nbColumns,l=0;l<u;++l)s.data[l]=t*r.data[l]+i*e.data[l];return s},n.copy=function(t,r){if(!(t instanceof n))throw new Error("first input must be a matrix");for(var i=o(t.nbRows,t.nbColumns,r),e=t.nbRows*t.nbColumns,a=0;a<e;++a)i.data[a]=t.data[a];return i},n.elementwiseProduct=function(t,r,i){if(!(t instanceof n))throw new Error("first input must be a matrix");if(!(r instanceof n))throw new Error("second input must be a matrix");if(!(t.nbRows===r.nbRows&&t.nbColumns===r.nbColumns||r.nbRows===t.nbRows&&1===r.nbColumns||1===r.nbRows&&r.nbColumns===t.nbColumns))throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");var e=o(t.nbRows,t.nbColumns,i),a=t.nbRows,s=t.nbColumns;if(t.nbRows===r.nbRows&&t.nbColumns===r.nbColumns)for(var u=a*s,l=0;l<u;++l)e.data[l]=t.data[l]*r.data[l];else if(r.nbRows===t.nbRows&&1===r.nbColumns)for(var f=0,h=0;h<a;++h)for(var m=r.data[h],c=0;c<s;++c)e.data[f]=t.data[f]*m,f++;else if(1===r.nbRows&&r.nbColumns===t.nbColumns)for(f=0,h=0;h<a;++h)for(c=0;c<s;++c)e.data[f]=t.data[f]*r.data[c],f++;return e},n.xy=function(t,r,i){if(!(t instanceof n))throw new Error("first input must be a matrix");if(!(r instanceof n))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbRows)throw new Error("matrices sizes do not match: ("+t.nbRows+","+r.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var e=o(t.nbRows,r.nbColumns,i),a=t.nbRows,s=t.nbColumns,u=r.nbColumns,l=0,f=0,h=0;h<a;++h){for(var m=f,c=0;c<u;++c)e.data[m]=0,m++;for(var d=0,w=0;w<s;++w){var p=t.data[l];m=f;for(c=0;c<u;++c)e.data[m]+=p*r.data[d],d++,m++;l++}f+=u}return e},n.txy=function(t,r,i){if(!(t instanceof n))throw new Error("second input must be a matrix");if(!(r instanceof n))throw new Error("third input must be a matrix");if(t.nbRows!==r.nbRows)throw new Error("matrices sizes do not match: ("+t.nbRows+","+r.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var e=o(t.nbColumns,r.nbColumns,i),a=t.nbColumns,s=t.nbRows,u=r.nbColumns,l=0,f=0,h=0,m=0;m<a;++m){for(var c=t.data[l],d=p,w=0;w<u;++w)e.data[f]=c*r.data[w],f++;l++}var p=u;for(h=1;h<s;++h){f=0;for(m=0;m<a;++m){for(c=t.data[l],d=p,w=0;w<u;++w)e.data[f]+=c*r.data[d],f++,d++;l++}p+=u}return e},n.axy=function(t,r,i,e){if(!(r instanceof n))throw new Error("second input must be a matrix");if(!(i instanceof n))throw new Error("third input must be a matrix");if(r.nbColumns!==i.nbRows)throw new Error("matrices sizes do not match: ("+r.nbRows+","+i.nbColumns+") - ("+i.nbRows+","+i.nbColumns+")");for(var a=o(r.nbRows,i.nbColumns,e),s=r.nbRows,u=r.nbColumns,l=i.nbColumns,f=0,h=0,m=0;m<s;++m){for(var c=h,d=0;d<l;++d)a.data[c]=0,c++;for(var w=0,p=0;p<u;++p){var v=t*r.data[f];c=h;for(d=0;d<l;++d)a.data[c]+=v*i.data[w],w++,c++;f++}h+=l}return a},n.ax=function(t,r,i){if(!(r instanceof n))throw new Error("second input must be a matrix");for(var e=o(r.nbRows,r.nbColumns,i),a=r.nbRows,s=r.nbColumns,u=1;u<=a;++u)for(var l=1;l<=s;++l)e.setValue(u,l,t*r.getValue(u,l));return e},n.axty=function(t,r,i,e){if(!(r instanceof n))throw new Error("second input must be a matrix");if(!(i instanceof n))throw new Error("third input must be a matrix");if(r.nbColumns!==i.nbColumns)throw new Error("matrices sizes do not match: ("+r.nbRows+","+i.nbColumns+") - ("+i.nbRows+","+i.nbColumns+")");for(var a=o(r.nbRows,i.nbRows,e),s=0;s<r.nbRows;++s)for(var u=0;u<i.nbRows;++u){a.data[s*a.nbColumns+u]=0;for(var l=0;l<r.nbColumns;++l)a.data[s*a.nbColumns+u]+=r.data[s*r.nbColumns+l]*i.data[u*i.nbColumns+l];a.data[s*a.nbColumns+u]=t*a.data[s*a.nbColumns+u]}return a},n.atxy=function(t,r,i,e){if(!(r instanceof n))throw new Error("second input must be a matrix");if(!(i instanceof n))throw new Error("third input must be a matrix");if(r.nbRows!==i.nbRows)throw new Error("matrices sizes do not match: ("+r.nbRows+","+i.nbColumns+") - ("+i.nbRows+","+i.nbColumns+")");for(var a=o(r.nbColumns,i.nbColumns,e),s=0,u=0;u<r.nbColumns;++u){for(var l=t*r.data[s*r.nbColumns+u],f=0;f<i.nbColumns;++f)a.data[u*a.nbColumns+f]=0;for(f=0;f<i.nbColumns;++f)a.data[u*a.nbColumns+f]+=l*i.data[s*i.nbColumns+f]}for(s=1;s<r.nbRows;++s)for(u=0;u<r.nbColumns;++u)for(l=t*r.data[s*r.nbColumns+u],f=0;f<i.nbColumns;++f)a.data[u*a.nbColumns+f]+=l*i.data[s*i.nbColumns+f];return a},n.diagonal=function(t,r){if(!(t instanceof n&&t.isVector()))throw new Error("first input must be a vector");for(var i=t.nbRows,e=o(i,i,r),a=0;a<i;++a){for(var s=0;s<i;++s)e.data[a*i+s]=0;e.data[a*i+a]=t.data[a]}return e},n.fillSymmetric=function(t,r,n){if(t<1)throw new Error("input number of rows and columns out of bounds: "+t);for(var i=o(t,t,n),e=0;e<t;++e){for(var a=0;a<e;++a)i.data[e*t+a]=i.data[a*t+e];for(a=e;a<i.nbColumns;++a)i.data[e*t+a]=r(e+1,a+1)}return i},n.fill=function(t,r,n,i){if(t<1)throw new Error("input number of rows out of bounds: "+t);if(r<1)throw new Error("input number of columns out of bounds: "+r);for(var e=o(t,r,i),a=0;a<t;++a)for(var s=0;s<r;++s)e.data[a*r+s]=n(a+1,s+1);return e},n.zeros=function(t,r,n){for(var i=o(t,r,n),e=t*r,a=0;a<e;++a)i.data[a]=0;return i},n.ones=function(t,r){for(var n=o(t,r),i=t*r,e=0;e<i;++e)n.data[e]=1;return n},n.identity=function(t){for(var r=o(t,t),n=t*t,i=0;i<n;++i)r.data[i]=0,i%(t+1)==0&&(r.data[i]=1);return r},n.normrnd=function(t,r,n,i){for(var e=o(t,r),a=t*r,s=0;s<a;++s)e.data[s]=M(n,i);return e},n.vectorHadamardProduct=function(t,r){return n.elementwiseProduct(t,r)},n.vectorDotProduct=function(t,r){if(!t.isVector())throw new Error("first argument must be a vector");if(!r.isVector())throw new Error("second argument must be a vector");if(t.nbRows!==r.nbRows)throw new Error("Vectors sizes do not match: ("+t.nbRows+") - ("+r.nbRows+")");for(var n=0,o=t.nbRows,i=0;i<o;++i)n+=t.data[i]*r.data[i];return n},n.choleskyDecomposition=function(t,r){void 0===r&&(r={});var o=r.epsSymmetric;null==o&&(o=0);var i=r.epsSdp;null==i&&(i=1e-16*t.nbRows);var e=r.pivoting;if(null==e&&(e="none"),"none"!=e&&"complete"!=e)throw new Error("unknown pivoting");var a=r.permutationOutputForm;if(null==a&&(a="matrix"),"vector"!=a&&"matrix"!=a)throw new Error("unknown permutation output form value");if(!(t instanceof n))throw new Error("input must be a matrix");if(!t.isSymmetric(o))throw new Error("input matrix must be symmetric");var s=t.nbRows;if("none"==e)for(var u=n.zeros(s,s),l=n.zeros(s,1),f=1;f<=s;++f){for(var h=f;h<=s;++h)l.data[h-1]=t.data[(h-1)*t.nbColumns+(f-1)];for(var m=1;m<=f-1;++m)for(h=f;h<=s;++h)l.data[h-1]-=u.data[(f-1)*u.nbColumns+(m-1)]*u.data[(h-1)*u.nbColumns+(m-1)];if(l.data[f-1]<=0)throw new Error("input matrix must be positive definite");for(h=f;h<=s;++h)u.data[(h-1)*u.nbColumns+(f-1)]=l.data[h-1]/Math.sqrt(l.data[f-1])}else{if("complete"!=e)throw new Error("internal error: unknown pivoting");l=n.zeros(s,1);var c,d=new n(t),w=n.fill(s,1,(function(t,r){return t}));for(m=1;m<=s;++m){f=-1;var p=Number.NEGATIVE_INFINITY;for(h=m;h<=s;++h){var v=d.data[(h-1)*d.nbColumns+(h-1)];v>p&&(f=h,p=v)}if(1==m&&(c=p),Math.abs(p)<=c*i)break;if(p<c*i)throw new Error("input matrix must be semi-definite positive");w.swapRows(m,f,{inPlace:!0}),d.swapRows(m,f,{inPlace:!0}),d.swapColumns(m,f,{inPlace:!0});for(h=m+1;h<=s;++h)l.data[h-1]=d.data[(h-1)*d.nbColumns+(m-1)];if(0==p)throw new Error("internal error: null pivot detected");for(h=m+1;h<=s;++h)d.data[(h-1)*d.nbColumns+(m-1)]/=p;for(h=m+1;h<=s;++h)for(f=m+1;f<=s;++f)d.data[(h-1)*d.nbColumns+(f-1)]-=l.data[h-1]*l.data[f-1]/p}}if("none"==e)return{lowerTriangular:u};if("complete"==e){var b,y=n.fill(s,1,(function(t,r){return Math.max(0,d.data[(t-1)*d.nbColumns+(t-1)])})),g=n.fill(s,s,(function(t,r){return t==r?1:t>r?d.data[(t-1)*d.nbColumns+(r-1)]:0}));if("vector"==a)b=w;else{if("matrix"!=a)throw new Error("internal error: unknown permutation output form value");b=n.fill(s,s,(function(t,r){return t==w.data[r-1]?1:0}))}return{lowerTriangular:g,diagonal:y,permutation:b}}throw new Error("internal error: unknown pivoting")},n.luDecomposition=function(t,r){void 0===r&&(r={});var o=r.permutationsOutputForm;if(null==o&&(o="matrix"),"vector"!=o&&"matrix"!=o)throw new Error("unknown permutation output form value");if(!(t instanceof n))throw new Error("input must be a matrix");if(!t.isSquare())throw new Error("input must be square");for(var i=t.nbRows,e=n.fill(i,1,(function(t,r){return t})),a=n.fill(i,1,(function(t,r){return t})),s=new n(t),u=1;u<=i-1;++u){for(var l=-1,f=-1,h=-1,m=u;m<=i;++m)for(var c=u;c<=i;++c){var d=Math.abs(s.data[(m-1)*s.nbColumns+(c-1)]);d>h&&(l=m,f=c,h=d)}e.swapRows(u,l,{inPlace:!0}),s.swapRows(u,l,{inPlace:!0}),a.swapRows(u,f,{inPlace:!0}),s.swapColumns(u,f,{inPlace:!0});var w=s.data[(u-1)*s.nbColumns+(u-1)];if(0!=w)for(m=u+1;m<=i;++m){s.data[(m-1)*s.nbColumns+(u-1)]/=w;for(c=u+1;c<=i;++c)s.data[(m-1)*s.nbColumns+(c-1)]-=s.data[(m-1)*s.nbColumns+(u-1)]*s.data[(u-1)*s.nbColumns+(c-1)]}}var p,v,b=n.fill(i,i,(function(t,r){return t>r?s.data[(t-1)*s.nbColumns+(r-1)]:t==r?1:0})),y=n.fill(i,i,(function(t,r){return r>=t?s.data[(t-1)*s.nbColumns+(r-1)]:0}));if("vector"==o)p=e,v=a;else{if("matrix"!=o)throw new Error("internal error: unknown permutation output form value");p=n.fill(i,i,(function(t,r){return r==e.data[t-1]?1:0})),v=n.fill(i,i,(function(t,r){return t==a.data[r-1]?1:0}))}return{lowerTriangular:b,upperTriangular:y,rowPermutation:p,columnPermutation:v}},n.qrDecomposition=function(t,r){function o(t,r){var n,o,i;if(0==r)n=t>=0?1:-1,o=0,i=Math.abs(t);else if(0==t)n=0,o=r>=0?1:-1,i=Math.abs(r);else if(Math.abs(t)>Math.abs(r)){o=(e=r/t)*(n=1/(a=(t>=0?1:-1)*Math.sqrt(1+e*e))),i=t*a}else{var e,a;n=(e=t/r)*(o=1/(a=(r>=0?1:-1)*Math.sqrt(1+e*e))),i=r*a}return[n,-o,i]}void 0===r&&(r={});var i=r.qLess||!1;if(!(t instanceof n))throw new Error("first input must be a matrix");if(t.nbRows<t.nbColumns)throw new Error("matrix has more columns than rows: ("+t.nbRows+") v.s. ("+t.nbColumns+")");var e=t.nbRows,a=t.nbColumns,s=new n(t),u=null;i||(u=n.identity(e));for(var l=1;l<=a;++l)for(var f=e;f>=l+1;--f){var h=(f-2)*s.nbColumns+(l-1),m=(f-1)*s.nbColumns+(l-1),c=o(s.data[h],s.data[m]),d=c[0],w=c[1],p=c[2];s.data[h]=p,s.data[m]=0;for(var v=l+1;v<=a;++v){var b=(f-2)*s.nbColumns+(v-1),y=(f-1)*s.nbColumns+(v-1),g=s.data[b],x=s.data[y];s.data[b]=d*g-w*x,s.data[y]=w*g+d*x}if(!i)for(v=1;v<=e;++v){var C=(v-1)*u.nbColumns+(f-2),R=(v-1)*u.nbColumns+(f-1);g=u.data[C],x=u.data[R];u.data[C]=d*g-w*x,u.data[R]=w*g+d*x}}return i?s:[u,s]},n.svdDecomposition=function(t,r){void 0===r&&(r={});var o=r.eps||1e-16,i=r.maxIter||100,e=r.svdForm||"thin";if(!(t instanceof n))throw new Error("first input must be a matrix");if(t.nbRows<t.nbColumns)throw new Error("matrix has more columns than rows: "+t.nbColumns+" v.s. "+t.nbRows);for(var a=t.nbRows,s=t.nbColumns,u=new n(t),l=u.matrixNorm("frobenius"),f=n.identity(s),h=0,m="function"==typeof Float64Array?new Float64Array(s):new Array(s);;){if(++h,-1!==i&&h>i)throw new Error("maximum number of iterations reached: "+i);for(var c=1;c<=s;++c){var d=u.vectorNorm("two","column",c);m[c-1]=d*d}var w=!0;for(c=2;c<=s;++c)for(var p=1;p<=c-1;++p){for(var v=m[p-1],b=m[c-1],y=0,g=1;g<=a;++g)y+=u.data[(g-1)*u.nbColumns+(p-1)]*u.data[(g-1)*u.nbColumns+(c-1)];if(!(Math.abs(y)<=o*Math.sqrt(a*v*b))&&!(Math.sqrt(v)<=o*l||Math.sqrt(b)<=o*l)){w=!1;var x=(v-b)/(2*y),C=(x>=0?1:-1)/(Math.abs(x)+Math.sqrt(1+x*x)),R=1/Math.sqrt(1+C*C),E=R*C;for(g=1;g<=a;++g){var M=u.data[(g-1)*u.nbColumns+(p-1)],A=u.data[(g-1)*u.nbColumns+(c-1)];u.data[(g-1)*u.nbColumns+(p-1)]=R*M+E*A,u.data[(g-1)*u.nbColumns+(c-1)]=-E*M+R*A}m[p-1]+=C*y,m[c-1]-=C*y;for(g=1;g<=s;++g){M=f.data[(g-1)*f.nbColumns+(p-1)],A=f.data[(g-1)*f.nbColumns+(c-1)];f.data[(g-1)*f.nbColumns+(p-1)]=R*M+E*A,f.data[(g-1)*f.nbColumns+(c-1)]=-E*M+R*A}}}if(1==w)break}var P="function"==typeof Float64Array?new Float64Array(s):new Array(s),z="function"==typeof Uint32Array?new Uint32Array(s):new Array(s);for(c=1;c<=s;++c){var k=Math.sqrt(m[c-1]);P[c-1]=k,z[c-1]=c}z.sort((function(t,r){return P[r-1]-P[t-1]}));var _=n.zeros(a,s),I=n.zeros(s,s),V=n.zeros(s,s);for(c=1;c<=s;++c){var F=z[c-1],O=P[F-1];if(I.data[(c-1)*I.nbColumns+(c-1)]=O,0!=O)for(p=1;p<=a;++p)_.data[(p-1)*_.nbColumns+(c-1)]=u.data[(p-1)*u.nbColumns+(F-1)]/O;for(p=1;p<=s;++p)V.data[(p-1)*V.nbColumns+(c-1)]=f.data[(p-1)*f.nbColumns+(F-1)]}if("thin"==e)return[_,I,V];var T=n.qrDecomposition(_)[0],S=n.zeros(a,a),N=n.zeros(a,s);for(c=1;c<=s;++c){F=z[c-1],O=P[F-1];if(N.data[(c-1)*N.nbColumns+(c-1)]=O,0!=O)for(p=1;p<=a;++p)S.data[(p-1)*S.nbColumns+(c-1)]=_.data[(p-1)*_.nbColumns+(c-1)];else for(p=1;p<=a;++p)S.data[(p-1)*S.nbColumns+(c-1)]=T.data[(p-1)*T.nbColumns+(c-1)]}for(c=s+1;c<=a;++c)for(p=1;p<=a;++p)S.data[(p-1)*S.nbColumns+(c-1)]=T.data[(p-1)*T.nbColumns+(c-1)];return"full"==e?[S,N,V]:void 0},n.eig=function(t,r){void 0===r&&(r={});var o=r.epsSymmetric;null==o&&(o=0);var i=r.maxIter;null==i&&(i=100);var e=r.sortedEigenvalues;if(null==e&&(e=!1),!(t instanceof n))throw new Error("input must be a matrix");if(!t.isSymmetric(o))throw new Error("input matrix must be symmetric");for(var a=t.nbRows,s=new n(t),u=n.identity(a),l=s.diagonal(),f=new n(l),h=n.zeros(a,1),m=0;;){if(++m,-1!==i&&m>i)throw new Error("maximum number of iterations reached: "+i);for(var c=0,d=1;d<=a-1;++d)for(var w=d+1;w<=a;++w)c+=Math.abs(s.data[(d-1)*s.nbColumns+(w-1)]);if(0==c)break;var p=m<4?.2*c/(a*a):0;for(d=1;d<=a-1;++d)for(w=d+1;w<=a;++w){var v=100*Math.abs(s.data[(d-1)*s.nbColumns+(w-1)]);if(m>4&&Math.abs(l.data[d-1])+v==Math.abs(l.data[d-1])&&Math.abs(l.data[w-1])+v==Math.abs(l.data[w-1]))s.data[(d-1)*s.nbColumns+(w-1)]=0;else if(Math.abs(s.data[(d-1)*s.nbColumns+(w-1)])>p){var b,y=l.data[w-1]-l.data[d-1];if(Math.abs(y)+v==Math.abs(y))b=s.data[(d-1)*s.nbColumns+(w-1)]/y;else{var g=.5*y/s.data[(d-1)*s.nbColumns+(w-1)];b=1/(Math.abs(g)+Math.sqrt(1+g*g)),g<0&&(b=-b)}var x=1/Math.sqrt(1+b*b),C=b*x,R=C/(1+x);y=b*s.data[(d-1)*s.nbColumns+(w-1)];for(h.data[d-1]-=y,h.data[w-1]+=y,l.data[d-1]-=y,l.data[w-1]+=y,s.data[(d-1)*s.nbColumns+(w-1)]=0,E=1;E<=d-1;++E){v=s.data[(E-1)*s.nbColumns+(d-1)],y=s.data[(E-1)*s.nbColumns+(w-1)];s.data[(E-1)*s.nbColumns+(d-1)]=v-C*(y+v*R),s.data[(E-1)*s.nbColumns+(w-1)]=y+C*(v-y*R)}for(E=d+1;E<=w-1;++E){v=s.data[(d-1)*s.nbColumns+(E-1)],y=s.data[(E-1)*s.nbColumns+(w-1)];s.data[(d-1)*s.nbColumns+(E-1)]=v-C*(y+v*R),s.data[(E-1)*s.nbColumns+(w-1)]=y+C*(v-y*R)}for(E=w+1;E<=a;++E){v=s.data[(d-1)*s.nbColumns+(E-1)],y=s.data[(w-1)*s.nbColumns+(E-1)];s.data[(d-1)*s.nbColumns+(E-1)]=v-C*(y+v*R),s.data[(w-1)*s.nbColumns+(E-1)]=y+C*(v-y*R)}for(var E=1;E<=a;++E){v=u.data[(E-1)*u.nbColumns+(d-1)],y=u.data[(E-1)*u.nbColumns+(w-1)];u.data[(E-1)*u.nbColumns+(d-1)]=v-C*(y+v*R),u.data[(E-1)*u.nbColumns+(w-1)]=y+C*(v-y*R)}}}for(d=1;d<=a;++d)f.data[d-1]+=h.data[d-1],l.data[d-1]=f.data[d-1],h.data[d-1]=0}var M=l,A=u;if(e){for(var P="function"==typeof Uint32Array?new Uint32Array(a):new Array(a),z=1;z<=a;++z)P[z-1]=z;P.sort((function(t,r){return l.data[r-1]-l.data[t-1]})),M=n.zeros(a,1),A=n.zeros(a,a);for(z=1;z<=a;++z){var k=P[z-1];M.data[z-1]=l.data[k-1];for(E=1;E<=a;++E)A.data[(E-1)*A.nbColumns+(z-1)]=u.data[(E-1)*u.nbColumns+(k-1)]}}return[A,M]},n.nullSpace=function(t,r){void 0===r&&(r={});var o=r.eps||void 0;if(!(t instanceof n))throw new Error("first input must be a matrix");var i=t.nbRows,e=t.nbColumns,a=null;if(i>=e){var s=(m=n.svdDecomposition(t,{maxIter:-1}))[0],u=m[1],l=m[2];for(void 0===o&&(o=i*(y(u.data[0])-u.data[0])),c=e;c>=1&&!(u.data[(c-1)*u.nbColumns+(c-1)]>o);--c);if((d=c)==e)a=n.zeros(e,1);else{a=new n.zeros(e,e-d);for(var f=d+1;f<=e;++f)for(var h=1;h<=e;++h)a.data[(h-1)*a.nbColumns+(f-(d+1)+1-1)]=l.data[(h-1)*l.nbColumns+(f-1)]}}else{var m,c,d;s=(m=n.svdDecomposition(t.transpose(),{maxIter:-1,svdForm:"full"}))[0],u=m[1],l=m[2];for(void 0===o&&(o=e*(y(u.data[0])-u.data[0])),c=i;c>=1&&!(u.data[(c-1)*u.nbColumns+(c-1)]>o);--c);if((d=c)==i)a=n.zeros(e,1);else{var w=new n.zeros(e,d);for(f=1;f<=d;++f)for(h=1;h<=e;++h)w.data[(h-1)*w.nbColumns+(f-1)]=s.data[(h-1)*s.nbColumns+(f-1)];var p=n.qrDecomposition(w)[0];for(a=new n.zeros(e,e-d),f=d+1;f<=e;++f)for(h=1;h<=e;++h)a.data[(h-1)*a.nbColumns+(f-(d+1)+1-1)]=p.data[(h-1)*p.nbColumns+(f-1)]}}return a},n.linsolveBackSubstitution=function(t,r){if(!(t instanceof n))throw new Error("first input must be a matrix");if(!(r instanceof n))throw new Error("second input must be a matrix");if(!t.isSquare())throw new Error("matrix is not square: ("+t.nbRows+","+t.nbColumns+")");if(t.nbRows!==r.nbRows)throw new Error("matrix and second member sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");if(1!==r.nbColumns)throw new Error("b is not a vector: ("+r.nbRows+","+r.nbColumns+")");for(var o=t.nbColumns,i=new n(r),e=o;e>=1;--e){var a=t.data[(e-1)*t.nbColumns+(e-1)];if(0==a)throw new Error("input matrix is not invertible: zero diagonal coefficient at index "+e);for(var s=e+1;s<=o;++s)i.data[e-1]-=t.data[(e-1)*t.nbColumns+(s-1)]*i.data[s-1];i.data[e-1]/=a}return i},n.linsolveForwardSubstitution=function(t,r){if(!(t instanceof n))throw new Error("first input must be a matrix");if(!(r instanceof n))throw new Error("second input must be a matrix");if(!t.isSquare())throw new Error("matrix is not square: ("+t.nbRows+","+t.nbColumns+")");if(t.nbRows!==r.nbRows)throw new Error("matrix and second member sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");if(1!==r.nbColumns)throw new Error("b is not a vector: ("+r.nbRows+","+r.nbColumns+")");for(var o=t.nbColumns,i=new n(r),e=1;e<=o;++e){var a=t.data[(e-1)*t.nbColumns+(e-1)];if(0==a)throw new Error("input matrix is not invertible: zero diagonal coefficient at index "+e);for(var s=1;s<=e-1;++s)i.data[e-1]-=t.data[(e-1)*t.nbColumns+(s-1)]*i.data[s-1];i.data[e-1]/=a}return i},n.randomOrthogonal=function(t){var r=n.normrnd(t,t),o=n.qrDecomposition(r),i=o[0],e=o[1],a=n.fill(1,t,(function(t,r){return e.data[(r-1)*e.nbColumns+(r-1)]>=0?1:-1}));return n.elementwiseProduct(i,a)},n.randomCorrelation=function(t,r){if(void 0===r&&(r={}),void 0===r.eps&&(r.eps=1e-14),void 0===r.epsLambda&&(r.epsLambda=1e-8),void 0===r.lambda){r.lambda=new B(t).sample();for(var o=0;o<t;++o)r.lambda[o]*=t}if(r.lambda.length!=t)throw new Error("number of input eigenvalues not equal to "+t+", but to "+r.lambda.length);var i=0;for(o=0;o<t;++o)i+=r.lambda[o];if(Math.abs(i-t)>r.epsLambda)throw new Error("input eigenvalues not summing to "+t);for(var e=r.eps,a=n.fill(1,t,(function(t,n){return r.lambda[n-1]})),s=n.randomOrthogonal(t),u=n.axty(1,n.elementwiseProduct(s,a),s),l=1;l<t;++l){for(var f=!0,h=1;h<=t;++h){var m=u.data[(h-1)*u.nbColumns+(h-1)];if(Math.abs(m-1)>e){f=!1;break}1!=m&&(u.data[(h-1)*u.nbColumns+(h-1)]=1)}if(f)break;o=-1;var c=-1;for(h=1;h<=t;++h)u.data[(h-1)*u.nbColumns+(h-1)]<1&&-1===o&&(o=h),u.data[(h-1)*u.nbColumns+(h-1)]>1&&(c=h);if(o>c){o=-1,c=-1;for(h=1;h<=t;++h)u.data[(h-1)*u.nbColumns+(h-1)]>1&&-1===o&&(o=h),u.data[(h-1)*u.nbColumns+(h-1)]<1&&(c=h)}var d=u.data[(o-1)*u.nbColumns+(o-1)],w=u.data[(o-1)*u.nbColumns+(c-1)],p=u.data[(c-1)*u.nbColumns+(c-1)],v=(w+Math.sqrt(w*w-(d-1)*(p-1)))/(p-1),b=1/Math.sqrt(1+v*v),y=b*v;for(h=1;h<=t;++h){var g=u.data[(o-1)*u.nbColumns+(h-1)],x=u.data[(c-1)*u.nbColumns+(h-1)];u.data[(o-1)*u.nbColumns+(h-1)]=b*g-y*x,u.data[(c-1)*u.nbColumns+(h-1)]=y*g+b*x}for(h=1;h<=t;++h){g=u.data[(h-1)*u.nbColumns+(o-1)],x=u.data[(h-1)*u.nbColumns+(c-1)];u.data[(h-1)*u.nbColumns+(o-1)]=b*g-y*x,u.data[(h-1)*u.nbColumns+(c-1)]=y*g+b*x}u.data[(o-1)*u.nbColumns+(o-1)]=1}for(h=1;h<=t;++h)u.data[(h-1)*u.nbColumns+(h-1)]=1;for(o=1;o<=t;++o)for(c=o+1;c<=t;++c){w=u.data[(o-1)*u.nbColumns+(c-1)];var C=u.data[(c-1)*u.nbColumns+(o-1)],R=Math.min(1,Math.max(-1,(w+C)/2));u.data[(o-1)*u.nbColumns+(c-1)]=R,u.data[(c-1)*u.nbColumns+(o-1)]=R}return u},n.linsolveExtendedKaczmarz=function(t,r,o){void 0===o&&(o={});var i=o.eps||1e-12,e=o.maxIter||1e5,a=!1;if(void 0!==o.randomized&&(a=o.randomized),!(t instanceof n))throw new Error("first input must be a matrix");if(!(r instanceof n))throw new Error("second input must be a matrix");if(t.nbRows!==r.nbRows)throw new Error("matrix and second member sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");if(1!==r.nbColumns)throw new Error("b is not a vector: ("+r.nbRows+","+r.nbColumns+")");var u=t.nbRows,l=t.nbColumns,f=n.zeros(l,1),h=new n(r),m=n.zeros(u,1),c=n.zeros(u,1),d=n.zeros(u,1),w=t.matrixNorm("frobenius"),p=w*w;if(0===w)return f;for(var v="function"==typeof Float64Array?new Float64Array(u):new Array(u),b=1;b<=u;++b){var y=t.vectorNorm("two","row",b);v[b-1]=y*y}for(var g="function"==typeof Float64Array?new Float64Array(l):new Array(l),x=1;x<=l;++x){var C=t.vectorNorm("two","column",x);g[x-1]=C*C}if(0==a)for(var R=0;;){if(++R,-1!==e&&R>=e)throw new Error("maximum number of iterations reached: "+e);for(b=1;b<=u;++b)if(0!=v[b-1]){var E=0;for(x=1;x<=l;++x)E+=t.data[(b-1)*t.nbColumns+(x-1)]*f.data[(x-1)*f.nbColumns];var M=E-(r.data[(b-1)*r.nbColumns+0]-h.data[(b-1)*h.nbColumns+0]);for(x=1;x<=l;++x)f.data[(x-1)*f.nbColumns]-=M/v[b-1]*t.data[(b-1)*t.nbColumns+(x-1)]}for(x=1;x<=l;++x)if(0!=g[x-1]){var A=0;for(b=1;b<=u;++b)A+=t.data[(b-1)*t.nbColumns+(x-1)]*h.data[(b-1)*h.nbColumns+0];for(b=1;b<=u;++b)h.data[(b-1)*h.nbColumns+0]-=A/g[x-1]*t.data[(b-1)*t.nbColumns+(x-1)]}var P=f.vectorNorm("two");if(d=n.xy(t,f,d),c=n.xmy(r,h,c),(F=(m=n.xmy(d,c,m)).vectorNorm("two"))<=i*w*P)break}else{var z=n.zeros(l,1),k="function"==typeof Float64Array?new Float64Array(u):new Array(u);for(b=1;b<=u;++b)k[b-1]=v[b-1]/p;var _=new s(k),I="function"==typeof Float64Array?new Float64Array(l):new Array(l);for(x=1;x<=l;++x)I[x-1]=g[x-1]/p;var V=new s(I);for(R=0;;){if(++R,-1!==e&&R>=e)throw new Error("maximum number of iterations reached: "+e);for(b=_.sample()+1,E=0,x=1;x<=l;++x)E+=t.data[(b-1)*t.nbColumns+(x-1)]*f.data[(x-1)*f.nbColumns];for(M=E-(r.data[(b-1)*r.nbColumns+0]-h.data[(b-1)*h.nbColumns+0]),x=1;x<=l;++x)f.data[(x-1)*f.nbColumns]-=M/v[b-1]*t.data[(b-1)*t.nbColumns+(x-1)];for(x=V.sample()+1,A=0,b=1;b<=u;++b)A+=t.data[(b-1)*t.nbColumns+(x-1)]*h.data[(b-1)*h.nbColumns+0];for(b=1;b<=u;++b)h.data[(b-1)*h.nbColumns+0]-=A/g[x-1]*t.data[(b-1)*t.nbColumns+(x-1)];if(R%8*Math.min(u,l)==0){P=f.vectorNorm("two");d=n.xy(t,f,d),c=n.xmy(r,h,c);var F=(m=n.xmy(d,c,m)).vectorNorm("two"),O=(z=n.txy(t,h,z)).vectorNorm("two");if(F<=i*w*P&&O<=i*p*P)break}}}return f},t.meanVector=function(t,r){void 0===(r=r)&&(r={});var o=r.regularizationMethod;if(void 0===o&&(o="none"),"none"!=o&&"linear-shrinkage"!=o)throw new Error("unsupported mean vector regularization method");var i,e=t.length,a=t[0].length;if("none"==o){i=s=n.fill(e,1,(function(r,n){return x(t[r-1])}))}else{if("linear-shrinkage"!=o)throw new Error("internal error: unsupported mean vector regularization method");var s=n.fill(e,1,(function(r,n){return x(t[r-1])})),u=x(s.toArray()),l=n.fill(e,1,(function(t,r){return u})),f=n.fill(e,1,(function(r,n){return P(t[r-1],t[r-1])})).sum()/e,h=e/a*f/(e/a*f+Math.pow(n.xmy(l,s).vectorNorm("two"),2));i=n.axpby(h,l,1-h,s)}return i},t.randomMeanVector=function(t,r){var o=null==r?1:r;return n.fill(t,1,(function(t,r){return M(0,o)}))},t.perturbedMeanVector=function(t,r){if(void 0===(r=r)&&(r={}),void 0===r.method&&(r.method="multiplicative-noise"),"multiplicative-noise"!=r.method)throw new Error("unsupported perturbation method");var o=r.sigma;if(void 0===r.sigma&&(o=.05),!(t=new n(t)).isVector())throw new Error("input must be a vector");return t.elemMap((function(t,r,n){return n*(1+o*M(0,1))}))},t.randomVariances=function(t,r){var o=null==r?1:r;return n.fill(t,1,(function(t,r){return function(t,r){null==t&&(t=0);null==r&&(r=1);var n,o=r*r,i=1.136717791056118,e=(1-i*i)/i*r,a=r*Math.sqrt(Math.PI/2);for(;;){var s;if(t<e){var u=(-t+Math.sqrt(t*t+4*o))/2/o;n=-Math.log(1-Math.random())/u,s=Math.exp(-(n-t)*(n-t)/2/o-u*(t-n+u*o/2))}else if(t<=0)n=Math.abs(M())*r+t,s=n>=0?1:0;else if(t<a){var l=Math.random()<t/(t+Math.sqrt(Math.PI/2)*r)?1:0,f=Math.random()*t,h=Math.abs(M()*r)+t;n=l*f+(1-l)*h,s=l*Math.exp(-(n-t)*(n-t)/2/o)+(1-l)}else n=M()*r+t,s=n>=0?1:0;if(Math.random()<=s)break}return n}(0,o)}))},t.perturbedVariances=function(t,r){if(void 0===(r=r)&&(r={}),void 0===r.method&&(r.method="multiplicative-noise"),"multiplicative-noise"!=r.method)throw new Error("unsupported perturbation method");var o=r.sigma;if(void 0===r.sigma&&(o=.05),!(t=new n(t)).isVector())throw new Error("input must be a vector");return t.elemMap((function(t,r,n){for(var i=n*(1+o*M(0,1));i<=0;)i=n*(1+o*M(0,1));return i}))},e.populationCount=function(t){return t=(t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135,t+=t>>>8,63&(t+=t>>>16)},e.prototype={constructor:e,resize:function(t){var r=this.words.length;if(!(r<<this.WORD_LOG>t)){var n=t+this.WORD_LENGTH>>>this.WORD_LOG;if("function"==typeof Uint32Array){var o=new Uint32Array(n);o.set(this.words),this.words=o}else{this.words[n-1]=0;for(var i=r;i<n-1;++i)this.words[i]=0}}},toString:function(){for(var t="",r=this.words.length,n=0;n<r;++n){var o="";t+=(o="function"==typeof Uint32Array?this.words[n].toString(2):(this.words[n]>>>0).toString(2)).length>=this.WORD_LENGTH?o:new Array(this.WORD_LENGTH-o.length+1).join("0")+o}return t},set:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]|=1<<t,this},setRange:function(t,r){this.words.length<<this.WORD_LOG<=r&&this.resize(r);for(var n=t;n<=r;++n)this.words[n>>>this.WORD_LOG]|=1<<n;return this},unset:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]&=~(1<<t),this},get:function(t){return 0!=(this.words[t>>>this.WORD_LOG]&1<<t)},clear:function(){return this.words="function"==typeof Uint32Array?new Uint32Array(0):new Array(0),this},flip:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]^=1<<t,this},isEmpty:function(){for(var t=this.words.length,r=0;r<t;++r)if(0!=this.words[r])return!1;return!0},nbSetBits:function(){for(var t=0,r=this.words.length,n=0;n<r;++n)t+=e.populationCount(0|this.words[n]);return t},toArray:function(){for(var t=new Array(this.nbSetBits()),r=0,n=this.words.length,o=0;o<n;++o)for(var i=this.words[o];0!=i;){var a=i&-i;t[r++]=(o<<this.WORD_LOG)+e.populationCount(a-1|0),i^=a}return t}},t.returns=function(t,r){void 0===(r=r)&&(r={}),void 0===r.method&&(r.method="arithmetic");var n=r.method;if("arithmetic"!=n&&"logarithmic"!=n)throw new Error("unsupported returns computation method");var o="function"==typeof Float64Array?new Float64Array(t.length-1):new Array(t.length-1);if("arithmetic"==n)for(var i=0;i<t.length-1;++i){if(0==t[i])throw new Error("internal error: null input value");o[i]=(t[i+1]-t[i])/t[i]}else{if("logarithmic"!=n)throw new Error("internal error: unsupported returns computation method");for(i=0;i<t.length-1;++i){if(t[i]<=0||t[i+1]<=0)throw new Error("internal error: negative or null input value");o[i]=Math.log(t[i+1]/t[i])}}return o},t.bestConstantlyRebalancedWeights=function(t,r){void 0===r&&(r={constraints:{}}),void 0===r.constraints&&(r.constraints={}),void 0===r.eps&&(r.eps=1e-4),void 0===r.maxIter&&(r.maxIter=1e4);var o=r.eps,i=r.maxIter,e=r.constraints.minWeights,a=r.constraints.maxWeights,s=t.length,u=t[0].length;return I((function(r){for(var o=n.zeros(s,1),i=1,e=0;e<u;++e)o=n.fill(s,1,(function(r,n){return t[r-1][e]}),o),i*=n.vectorDotProduct(r,o);return-i}),(function(r){for(var o,i=n.zeros(s,1),e="function"==typeof Float64Array?new Float64Array(u):new Array(u),a=1,l=!1,f=0;f<u;++f){i=n.fill(s,1,(function(r,n){return t[r-1][f]}),i);var h=n.vectorDotProduct(r,i);e[f]=h,!1===l&&(a*=h,Math.abs(h)<=1e-12&&(l=!0))}if(!1!==l)throw new Error("null portfolio relative detected, unsuported case");o=n.fill(u,1,(function(t,r){return a/e[t-1]}));var m=n.zeros(u,1),c=n.zeros(s,1);for(f=0;f<s;++f)m=n.fill(u,1,(function(r,n){return t[f][r-1]}),m),c.data[f]=-n.vectorDotProduct(m,o);return c}),(function(t){return T(t.data,e,a)}),(function(t){return new n(W(t.data,e,a))}),new n(W(n.ones(s,1).data,e,a)),{eps:o,maxIter:i,maxLine:i})[0].toArray()},t.clusterRiskParityWeights=function(r,o){void 0===o&&(o={});var i=o.clusteringMode||"ftca",e=(r=new n(r).toCovarianceMatrix(r)).nbRows,a=[];if("manual"===i){a=o.clusters||[];for(var s=new Array(e),u=0;u<s.length;++u)s[u]=0;for(var l=0;l<a.length;++l){if(0===a[l].length)throw new Error("empty cluster at index: "+l);for(var f=0;f<a[l].length;++f){var h=a[l][f];if(h<1||h>e)throw new Error("asset index out of bounds: "+h);s[h-1]++}}for(u=0;u<s.length;++u)if(1!==s[u])throw 0===s[u]?new Error("missing asset index: "+(u+1)):s[u]>1?new Error("duplicate asset index: "+(u+1)):new Error("unknown error")}else{if("ftca"!==i)throw new Error("unsupported clustering method");a=function(t,r){void 0===(r=r)&&(r=.5);for(var o=[],i=(t=new n(t)).nbRows,e=new Array(i),a=0;a<e.length;++a)e[a]=a+1;for(;0!=e.length;){if(1===e.length){var s=[e[0]];e[0]=null,o.push(s)}else{var u=t.submatrix(e,e).toRowArray((function(t,r,n){return t!=r})),l=new Array(e);for(a=0;a<e.length;++a)l[a]=x(u[a]);var f=0,h=-1,m=-1,c=0,d=-1,w=1;for(a=0;a<e.length;++a)l[a]>=m&&(f=e[a],h=a,m=l[a]),l[a]<=w&&(c=e[a],d=a,w=l[a]);if(t.getValueAt(f,c)>r){var p=f===c?[f]:[f,c];e[h]=null,e[d]=null;for(a=0;a<e.length;++a){if(null!==e[a])(t.getValueAt(e[a],f)+t.getValueAt(e[a],c))/2>r&&(p.push(e[a]),e[a]=null)}o.push(p)}else{var v=[f];e[h]=null;for(a=0;a<e.length;++a)null!==e[a]&&t.getValueAt(e[a],f)>r&&(v.push(e[a]),e[a]=null);if(o.push(v),f!==c){var b=[c];e[d]=null;for(a=0;a<e.length;++a)null!==e[a]&&t.getValueAt(e[a],c)>r&&(b.push(e[a]),e[a]=null);o.push(b)}}}var y=[];for(a=0;a<e.length;++a)null!==e[a]&&y.push(e[a]);e=y}return o}(r.getCorrelationMatrix().toRowArray(),o.ftcaThreshold)}var m=a.length,c=n.zeros(m,e);for(u=0;u<m;++u){var d=a[u].slice().sort((function(t,r){return t-r})),w=r.submatrix(d,d),p=t.equalRiskContributionWeights(w,o);for(l=0;l<p.length;++l)c.setValueAt(u+1,d[l],p[l])}var v=n.xy(c,n.axty(1,r,c)),b=t.equalRiskContributionWeights(v,o);return n.txy(c,new n(b)).toArray()},t.equalRiskBoundingWeights=function(r,o){void 0===o&&(o={}),void 0===o.constraints&&(o.constraints={});var i=(r=new n(r)).nbRows,e=1/0,a=[],s=[],u=new m(i),l=u.next();for(l=u.next();-1!=l;){var f,h,c=l,d=c.length,w=r.submatrix(c,c);if(o.constraints.minWeights){f="function"==typeof Float64Array?new Float64Array(d):new Array(d);for(var p=0;p<d;++p)f[p]=o.constraints.minWeights[c[p]-1]}if(o.constraints.maxWeights){h="function"==typeof Float64Array?new Float64Array(d):new Array(d);for(p=0;p<d;++p)h[p]=o.constraints.maxWeights[c[p]-1]}try{var v=t.equalRiskContributionWeights(w,{eps:o.eps,maxCycles:-1,outputPortfolioVolatility:!0,constraints:{minWeights:f,maxWeights:h}}),b=v[0],y=v[1],g=y*y/d;g<e&&(e=g,a=c,s=b)}catch(C){if("infeasible problem detected: the restricted simplex is empty"!==C.message&&"internal error: maximum number of iterations reached when searching for a bracketing interval, the problem might be infeasible"!==C.message)throw C}l=u.next()}if(e==1/0)throw new Error("no feasible portfolio generated");var x=n.zeros(i,1);for(p=0;p<a.length;++p)x.setValueAt(a[p],1,s[p]);return x.toArray()},t.equalRiskContributionWeights=function(r,o){var i=(r=new n(r)).nbRows,e=n.fill(i,1,(function(t,r){return 1/i}));return t.riskBudgetingWeights(r,e,o)},t.equalWeights=function(t,r){return n.fill(t,1,(function(r,n){return 1/t})).toArray()},t.globalMinimumVarianceWeights=function(t,r){void 0===r&&(r={}),void 0===r.constraints&&(r.constraints={}),void 0===r.optimizationMethodParams&&(r.optimizationMethodParams={});var o,i=(t=new n(t)).nbRows;o=null==r.mu?n.zeros(i,1):new n(r.mu);var e,a=r.optimizationMethod;if(void 0===a&&(a="automatic"),"critical-line"!=a&&"gsmo"!=a&&"automatic"!=a)throw new Error("unsupported optimisation method");if(r.optimizationMethodParams.minimumRiskToleranceValueOnlyGsmo=!0,"automatic"==a)e=new D(o,t,r);else if("critical-line"==a)e=new L(o,t,r);else{if("gsmo"!=a)throw new Error("internal error: unsupported optimisation method");e=new U(o,t,r)}return e.getLowestRiskTolerancePortfolio().toArray()},t.inverseVolatilityWeights=function(t,r){var o=new n(t).elemMap((function(t,r,n){return 1/Math.sqrt(n)}));return(o=o.normalize(o)).toArray()},t.maximumSharpeRatioWeights=function(t,r,n,o){void 0===o&&(o={constraints:{}}),void 0===o.constraints&&(o.constraints={}),void 0===o.optimizationMethodParams&&(o.optimizationMethodParams={});var i=o.optimizationMethod;if(void 0===i&&(i="automatic"),"critical-line"!=i&&"gsmo"!=i&&"automatic"!=i)throw new Error("unsupported optimisation method");var e,a=o.epsVolatility;if(void 0===a&&(a=1e-4),"automatic"==i)e=new D(t,r,o);else if("critical-line"==i)e=new L(t,r,o);else{if("gsmo"!=i)throw new Error("internal error: unsupported optimisation method");e=new U(t,r,o)}return e.restrict("minVolatility",a),e.restrict("minReturn",n),e.computeMaximumSharpeRatioEfficientPortfolio(n)[0].toArray()},L.prototype=Object.create(G.prototype),L.prototype.constructor=L,L.prototype.getHighestRiskTolerancePortfolio=function(t){return this.cornerPortfolios[0][0]},L.prototype.getHighestRiskTolerance=function(t){return this.cornerPortfolios[0][1]},L.prototype.getLowestRiskTolerancePortfolio=function(t){return this.cornerPortfolios[this.cornerPortfolios.length-1][0]},L.prototype.getLowestRiskTolerance=function(t){return this.cornerPortfolios[this.cornerPortfolios.length-1][1]},L.prototype.computeEfficientPortfolio=function(t,r){if(null==t)throw new Error("missing constraint type");var o,i=this;if("return"==t)o=function(t){return i.computePortfolioReturn(t[0])};else if("volatility"==t)o=function(t){return i.computePortfolioVolatility(t[0])};else{if("riskTolerance"!=t)throw new Error("unknown constraint type");o=function(t){return t[1]}}if(null==r)throw new Error("missing constraint value");var e=function(t,r,n,o){var i=n.length-1,e=0,a=(n[i][0],n[e][0],t(n[i])),s=t(n[e]);if(r>s+o||r<a-o)return[];if(Math.abs(r-a)<=o)return[i];if(Math.abs(r-s)<=o)return[e];for(;i-e!=1;){var u=Math.floor((i+e)/2),l=t(n[u]);if(l>r)e=u;else{if(!(l<r))return[u];i=u}}return[i,e]}(o,r,this.cornerPortfolios,this.epsEfficientPortfolioComputation);if(0==e.length)return[];if(1==e.length){var a=e[0];return[this.cornerPortfolios[a][0],this.cornerPortfolios[a][1]]}a=e[0];var s,u=this.cornerPortfolios[a][0],l=o(this.cornerPortfolios[a]),f=e[1],h=this.cornerPortfolios[f][0],m=o(this.cornerPortfolios[f]);if("return"===t)s=(m-r)/(m-l);else if("volatility"===t){var c=n.vectorDotProduct(n.xy(this.sigma,u),h),d=l*l+m*m-2*c,w=m*m-r*r,p=-2*(m*m-c)/2,v=p>=0?1:-1,b=p*p-d*w;if(b<0)throw new Error("internal error; the covariance matrix might not be semi-definite positive");var y=-(p+v*Math.sqrt(b)),g=y/d,x=w/y;if(g>0&&g<1)s=g;else{if(!(x>0&&x<1))throw new Error("internal error: the covariance matrix might not be semi-definite positive");s=x}}else{if("riskTolerance"!==t)throw new Error("internal error: unknown constraint type");s=(m-r)/(m-l)}i=this;return[n.fill(u.nbRows,1,(function(t,r){var n=s*u.getValue(t,1)+(1-s)*h.getValue(t,1),o=i.lowerBounds.data[t-1],e=i.upperBounds.data[t-1];return Math.max(Math.min(n,e),o)})),s*this.cornerPortfolios[a][1]+(1-s)*this.cornerPortfolios[f][1]]},L.prototype.getCornerPortfolios=function(){for(var t=new Array(this.cornerPortfolios.length),r=0;r<t.length;++r)t[r]=new n(this.cornerPortfolios[r][0]);return t},L.prototype.restrict=function(t,r){if(null==t)throw new Error("missing constraint type");if(null==r)throw new Error("missing constraint value");if("minReturn"==t){if(this.getLowestReturn()<r){if(this.getHighestReturn()<r)throw new Error("impossible to restrict the efficient frontier: the minimum return constraint is not feasible");if(0==(a=this.computeEfficientPortfolio("return",r+.5*this.epsEfficientPortfolioComputation)).length)throw new Error("internal error: no efficient portfolio with a return greater than "+r);var n=a[0],o=a[1],e=new Array;for(i=0;i<this.cornerPortfolios.length-1&&this.cornerPortfolios[i][1]>o;++i)e.push(this.cornerPortfolios[i]);e.push([n,o]),this.cornerPortfolios=e}}else{if("minVolatility"!=t)throw new Error("unknown constraint type");if(this.getLowestVolatility()<r){var a;if(this.getHighestVolatility()<r)throw new Error("impossible to restrict the efficient frontier: the minimum volatility constraint is not feasible");if(0==(a=this.computeEfficientPortfolio("volatility",r+.5*this.epsEfficientPortfolioComputation)).length)throw new Error("internal error: no efficient portfolio with a volatility greater than "+r+": the covariance matrix might not be semi-definite positive");n=a[0],o=a[1],e=new Array;for(i=0;i<this.cornerPortfolios.length-1&&this.cornerPortfolios[i][1]>o;++i)e.push(this.cornerPortfolios[i]);e.push([n,o]),this.cornerPortfolios=e}}},L.prototype.computeMaximumSharpeRatioEfficientPortfolio=function(t){var r=function(t){var r=this.cornerPortfolios.length-1,n=0;if(r==n)return r;for(;r-n!=1;){var o=Math.floor((r+n)/2),i=this.cornerPortfolios[o][0],e=this.computePortfolioSharpeRatio(i,t),a=o+1,s=this.cornerPortfolios[a][0],u=this.computePortfolioSharpeRatio(s,t);if(e>u)r=o;else{if(!(e<u)){r=a,n=o;break}n=o}}return r}.call(this,t),o=this.cornerPortfolios[r][0],i=[[o,this.computePortfolioSharpeRatio(o,t),this.cornerPortfolios[r][1]]];r<=this.cornerPortfolios.length-2&&i.push(a.call(this,t,r+1,r)),r>=1&&i.push(a.call(this,t,r,r-1));var e=v(i,(function(t,r){return t[1]-r[1]}))[0];return[e[0],e[2]];function a(t,r,o){var i=this.cornerPortfolios,e=i[r][0],a=i[o][0],s=this.computePortfolioSharpeRatio(e,t),u=this.computePortfolioReturn(e),l=this.computePortfolioVolatility(e),f=l*l,h=this.computePortfolioSharpeRatio(a,t),m=this.computePortfolioReturn(a),c=this.computePortfolioVolatility(a),d=c*c,w=u-m,p=m-t,b=w*w,y=2*w*p,g=p*p,x=n.vectorDotProduct(n.xy(this.sigma,e),a),C=f+d-2*x,R=-2*(d-x),E=b*R-y*C,M=y*d-g*R,A=2*(b*d-g*C)/2,P=A>=0?1:-1,z=A*A-E*M;if(Math.abs(z)<=1e-16&&(z=0),z<0)throw new Error("internal error, the covariance matrix might not be semi-definite positive");var k=-(A+P*Math.sqrt(z)),_=k/E,I=M/k,V=[[e,s,i[r][1]],[a,h,i[o][1]]];if(_>0&&_<1){var F=n.fill(e.nbRows,1,(function(t,r){return _*e.getValue(t,1)+(1-_)*a.getValue(t,1)})),O=this.computePortfolioSharpeRatio(F,t),T=_*i[r][1]+(1-_)*i[o][1];V.push([F,O,T])}if(I>0&&I<1){var S=n.fill(e.nbRows,1,(function(t,r){return I*e.getValue(t,1)+(1-I)*a.getValue(t,1)})),N=this.computePortfolioSharpeRatio(S,t),W=I*i[r][1]+(1-I)*i[o][1];V.push([S,N,W])}return v(V,(function(t,r){return t[1]-r[1]}))[0]}},U.prototype=Object.create(G.prototype),U.prototype.constructor=U,U.prototype.getHighestRiskTolerancePortfolio=function(t){return this.highestRiskTolerancePortfolio},U.prototype.getHighestRiskTolerance=function(t){return this.highestRiskTolerance},U.prototype.getLowestRiskTolerancePortfolio=function(t){return this.lowestRiskTolerancePortfolio},U.prototype.getLowestRiskTolerance=function(t){return this.lowestRiskTolerance},U.prototype.computeEfficientPortfolio=function(t,r){if(null==t)throw new Error("internal error: missing constraint type");var o,i,e=this;if("return"==t)o=function(t){return e.computePortfolioReturn(t)},i=function(t){return t.ret};else if("volatility"==t)o=function(t){return e.computePortfolioVolatility(t)},i=function(t){return t.volatility};else if("riskTolerance"!=t)throw new Error("internal error: unknown constraint type");if(null==r)throw new Error("internal error: missing constraint value");var a,s,u=this.nbAssets,l=this.mu,f=this.sigma,h=this.lowerBounds,m=this.upperBounds,c=this.epsEfficientPortfolioComputation,d=f,w=n.ones(u,1),p=h,v=m;if("return"===t||"volatility"===t){var b=this.getLowestRiskTolerancePortfolio(),y=o(b),g=this.getHighestRiskTolerancePortfolio(),x=o(g);if(r>x+c||r<y-c)return[];if(Math.abs(r-y)<=c)a=b,s=this.getLowestRiskTolerance();else if(Math.abs(r-x)<=c)a=g,s=this.getHighestRiskTolerance();else{var C=n.fill(u,1,(function(t,r){return 1/u})),R=V(n.ones(u,1),C,w,1,p,v);a=R[0];e=this;s=_((function(t){var s=e.cachedEfficientPortfolios.get(t);if(s)return a=s.weights,i(s)-r;var u=n.ax(-t,l),f=F(d,u,w,1,p,v,{x0:a,antiCycling:e.antiCyclingGsmo,eps:e.epsGsmo,maxIter:e.maxIterationsGsmo});return a=f[0],e.cachedEfficientPortfolios.set(t,{weights:a,ret:e.computePortfolioReturn(a),volatility:e.computePortfolioVolatility(a)}),o(a)-r}),this.getLowestRiskTolerance(),this.getHighestRiskTolerance())}}else{if("riskTolerance"!==t)throw new Error("internal error: unknown constraint type");var E=r,M=n.ax(-E,l),A=F(d,M,w,1,p,v,{antiCycling:this.antiCyclingGsmo,eps:this.epsGsmo,maxIter:this.maxIterationsGsmo});a=A[0],s=E}return[a,s]},U.prototype.restrict=function(t,r){if(null==t)throw new Error("missing constraint type");if(null==r)throw new Error("missing constraint value");if("minReturn"==t){if(this.getLowestReturn()<r){if(this.getHighestReturn()<r)throw new Error("impossible to restrict the efficient frontier: the minimum return constraint is not feasible");if(0==(i=this.computeEfficientPortfolio("return",r+.5*this.epsEfficientPortfolioComputation)).length)throw new Error("internal error: no efficient portfolio with a return greater than "+r);var n=i[0],o=i[1];this.lowestRiskTolerancePortfolio=n,this.lowestRiskTolerance=o,this.lowestRiskTolerance>=this.highestRiskTolerance&&(this.highestRiskTolerancePortfolio=n,this.highestRiskTolerance=o)}}else{if("minVolatility"!=t)throw new Error("unknown constraint type");if(this.getLowestVolatility()<r){var i;if(this.getHighestVolatility()<r)throw new Error("impossible to restrict the efficient frontier: the minimum volatility constraint is not feasible");if(0==(i=this.computeEfficientPortfolio("volatility",r+.5*this.epsEfficientPortfolioComputation)).length)throw new Error("internal error: no efficient portfolio with a volatility greater than "+r+": the covariance matrix might not be semi-definite positive");n=i[0],o=i[1];this.lowestRiskTolerancePortfolio=n,this.lowestRiskTolerance=o,this.lowestRiskTolerance>=this.highestRiskTolerance&&(this.highestRiskTolerancePortfolio=n,this.highestRiskTolerance=o)}}},U.prototype.computeMaximumSharpeRatioEfficientPortfolio=function(t){var r,o=this.nbAssets,i=this.mu,e=this.sigma,a=this.lowerBounds,s=this.upperBounds,u=(this.epsEfficientPortfolioComputation,e),l=n.ones(o,1),f=a,h=s,m=this,c=function(t,r,n,o){void 0===o&&(o={});var i=o.maxIter;void 0===i&&(i=-1);var e=o.eps;void 0===e&&(e=1e-6);var a=(Math.sqrt(5)-1)/2,s=r,u=n,l=u-a*(u-s),f=s+a*(u-s),h=t(r),m=t(n),c=t(l),d=t(f);if(r>n)throw new Error("bracketing interval lower bound "+r+" greater than bracketing interval upper bound "+n);for(var w=0;;){if(-1!==i&&w>i)throw new Error("maximum number of iterations reached: "+i);if(++w,c<=d?(u=f,f=l,d=c,c=t(l=u-a*(u-s))):c>d&&(s=l,l=f,c=d,d=t(f=s+a*(u-s))),Math.abs(u-s)<=e)return c<d?h<c?[r,h]:[l,c]:m<d?[n,m]:[f,d]}}((function(o){var e=n.ax(-o,i),a=F(u,e,l,1,f,h,{antiCycling:m.antiCyclingGsmo,eps:m.epsGsmo,maxIter:m.maxIterationsGsmo});return r=a[0],-m.computePortfolioSharpeRatio(r,t)}),this.getLowestRiskTolerance(),this.getHighestRiskTolerance());return[r,c[0]]},D.prototype=Object.create(G.prototype),D.prototype.constructor=D,D.prototype.getHighestRiskTolerancePortfolio=function(t){return this.efficientFrontier.getHighestRiskTolerancePortfolio(t)},D.prototype.getHighestRiskTolerance=function(t){return this.efficientFrontier.getHighestRiskTolerance()},D.prototype.getLowestRiskTolerancePortfolio=function(t){return this.efficientFrontier.getLowestRiskTolerancePortfolio(t)},D.prototype.getLowestRiskTolerance=function(t){return this.efficientFrontier.getLowestRiskTolerance()},D.prototype.computeEfficientPortfolio=function(t,r){return this.efficientFrontier.computeEfficientPortfolio(t,r)},D.prototype.getCornerPortfolios=function(){if("critical-line"==this.efficientFrontierOptimizationMethod)return this.efficientFrontier.getCornerPortfolios();throw new Error("internal error: unsupported method")},D.prototype.restrict=function(t,r){return this.efficientFrontier.restrict(t,r)},D.prototype.computeMaximumSharpeRatioEfficientPortfolio=function(t){return this.efficientFrontier.computeMaximumSharpeRatioEfficientPortfolio(t)},G.prototype.getHighestReturnPortfolio=function(t){return this.getHighestRiskTolerancePortfolio()},G.prototype.getHighestReturn=function(t){return this.computePortfolioReturn(this.getHighestReturnPortfolio())},G.prototype.getLowestReturnPortfolio=function(t){return this.getLowestRiskTolerancePortfolio()},G.prototype.getLowestReturn=function(t){return this.computePortfolioReturn(this.getLowestReturnPortfolio())},G.prototype.getHighestVolatilityPortfolio=function(t){return this.getHighestRiskTolerancePortfolio()},G.prototype.getHighestVolatility=function(t){return this.computePortfolioVolatility(this.getHighestVolatilityPortfolio())},G.prototype.getLowestVolatilityPortfolio=function(t){return this.getLowestRiskTolerancePortfolio()},G.prototype.getLowestVolatility=function(t){return this.computePortfolioVolatility(this.getLowestVolatilityPortfolio())},G.prototype.getHighestRiskTolerancePortfolio=function(t){throw new Error("internal error: function is not implemented")},G.prototype.getHighestRiskTolerance=function(t){throw new Error("internal error: function is not implemented")},G.prototype.getLowestRiskTolerancePortfolio=function(t){throw new Error("internal error: unction is not implemented")},G.prototype.getLowestRiskTolerance=function(t){throw new Error("internal error: function is not implemented")},G.prototype.computePortfolioReturn=function(t){return n.vectorDotProduct(this.mu,t)},G.prototype.computePortfolioVolatility=function(t){var r=n.vectorDotProduct(n.xy(this.sigma,t),t);if(Math.abs(r)<=this.epsPortfolioVolatility)r=0;else if(r<0&&r<-this.epsPortfolioVolatility)throw new Error("internal error: negative volatility, covariance matrix might not be semi-definite positive");return Math.sqrt(r)},G.prototype.computePortfolioSharpeRatio=function(t,r){if(null==r||null==r)throw new Error("internal error: missing risk free rate");var n=this.computePortfolioReturn(t)-r,o=Math.max(this.epsPortfolioVolatility,this.computePortfolioVolatility(t));if(0==o)throw new Error("internal error: null volatility when computing the Sharpe ratio");return n/o},G.prototype.computeEfficientPortfolio=function(t,r){throw new Error("internal error: function is not implemented")},G.prototype.restrict=function(t,r){throw new Error("internal error: function is not implemented")},G.prototype.computeMaximumSharpeRatioEfficientPortfolio=function(t){throw new Error("internal error: function is not implemented")},t.meanVarianceOptimizationWeights=function(t,r,n){void 0===n&&(n={constraints:{}}),void 0===n.constraints&&(n.constraints={}),void 0===n.optimizationMethodParams&&(n.optimizationMethodParams={});var o=n.optimizationMethod;if(void 0===o&&(o="automatic"),"critical-line"!=o&&"gsmo"!=o&&"automatic"!=o)throw new Error("unsupported optimisation method");var i,e,a=n.constraints.return,s=n.constraints.volatility,u=n.constraints.maxVolatility,l=n.constraints.riskTolerance;if(void 0===a&&void 0===s&&void 0===u&&null==l)throw new Error("missing return, volatility or risk tolerance constraints");if(void 0!==a&&void 0!==s||void 0!==a&&void 0!==u)throw new Error("simultaneous return and volatility constraints");if(void 0!==l&&(void 0!==a||void 0!==u||void 0!==s))throw new Error("simultaneous risk tolerance and return or volatility constraints");if("automatic"==o)i=new D(t,r,n);else if("critical-line"==o)i=new L(t,r,n);else{if("gsmo"!=o)throw new Error("internal error: unsupported optimisation method");i=new U(t,r,n)}if(void 0!==a){if(0==(p=i.computeEfficientPortfolio("return",a)).length)throw new Error("no matching efficient portfolio with a return equal to "+a);e=p[0]}else if(void 0!==s){if(0==(p=i.computeEfficientPortfolio("volatility",s)).length)throw new Error("no matching efficient portfolio with a volatility equal to "+s);e=p[0]}else if(void 0!==l){var f=i.getHighestRiskTolerancePortfolio(),h=i.getHighestRiskTolerance(),m=i.getLowestRiskTolerancePortfolio(),c=i.getLowestRiskTolerance();if(l>h-(d=i.epsEfficientPortfolioComputation))e=f;else if(l<c+d)e=m;else{if(0==(p=i.computeEfficientPortfolio("riskTolerance",l)).length)throw new Error("internal error: no matching efficient portfolio with a risk tolerance equal to "+l);e=p[0]}}else if(void 0!==u){var d,w=i.getHighestVolatilityPortfolio();if(u>i.getHighestVolatility()-(d=i.epsEfficientPortfolioComputation))e=w;else{var p;if(0==(p=i.computeEfficientPortfolio("volatility",u)).length)throw new Error("no matching efficient portfolio with a volatility lower than or equal to "+u);e=p[0]}}return e.toArray()},t.meanVarianceEfficientFrontierNearestWeights=function(t,r,o,i){void 0===i&&(i={constraints:{}}),void 0===i.constraints&&(i.constraints={}),void 0===i.optimizationMethodParams&&(i.optimizationMethodParams={});var e=i.optimizationMethod;if(void 0===e&&(e="automatic"),"critical-line"!=e&&"gsmo"!=e&&"automatic"!=e)throw new Error("unsupported optimisation method");var a,s;t=new n(t);if("automatic"==e)a=new D(r,o,i);else if("critical-line"==e)a=new L(r,o,i);else{if("gsmo"!=e)throw new Error("internal error: unsupported optimisation method");a=new U(r,o,i)}if("critical-line"==e||"critical-line"==a.efficientFrontierOptimizationMethod)s=a.getCornerPortfolios();else{if("gsmo"!=e&&"gsmo"!=a.efficientFrontierOptimizationMethod)throw new Error("internal error: unsupported optimisation method");var u=i.optimizationMethodParams.nbPortfoliosGsmo;null==u&&(u=100),s=new Array(u);for(var l=a.getLowestReturn(),f=(a.getHighestReturn()-l)/(u-1),h=0;h<u;++h){var m,c=l+h*f;if(0==(m=a.computeEfficientPortfolio("return",c)).length)throw new Error("internal error: no matching efficient portfolio with a return of "+c);s[h]=m[0]}}var w=Number.POSITIVE_INFINITY;for(h=0;h<s.length-1;++h){var p=s[h],v=d(t,s[h+1],p),b=n.xmy(t,new n(v)).vectorNorm("two");b<=w&&(m=v,w=b)}return m},t.meanVarianceEfficientFrontierPortfolios=function(t,r,n){void 0===n&&(n={constraints:{}}),void 0===n.constraints&&(n.constraints={}),void 0===n.optimizationMethodParams&&(n.optimizationMethodParams={});var o=n.optimizationMethod;if(void 0===o&&(o="automatic"),"critical-line"!=o&&"gsmo"!=o&&"automatic"!=o)throw new Error("unsupported optimisation method");var i,e=n.nbPortfolios||100,a=n.discretizationType;if(null==a&&(a="return"),"return"!=a&&"volatility"!=a&&"riskTolerance"!=a)throw new Error("unsupported discretization type");if("automatic"==o)i=new D(t,r,n);else if("critical-line"==o)i=new L(t,r,n);else{if("gsmo"!=o)throw new Error("internal error: unsupported optimisation method");i=new U(t,r,n)}var s,u,l=new Array(e);if("return"==a)s=i.getLowestReturn(),u=i.getHighestReturn();else if("volatility"==a)s=i.getLowestVolatility(),u=i.getHighestVolatility();else{if("riskTolerance"!=a)throw new Error("internal error: unsupported discretization type");s=i.getLowestRiskTolerance(),u=i.getHighestRiskTolerance()}for(var f=1==e?-1:(u-s)/(e-1),h=1==e?(s+u)/2:s,m=0;m<e;++m){var c=h+m*f,d=i.computeEfficientPortfolio(a,c);if(0==d.length)throw new Error("internal error: no matching efficient portfolio with a constraint value "+a+" equal to "+c);d=d[0];var w=i.computePortfolioReturn(d),p=i.computePortfolioVolatility(d);l[m]=[d.toArray(),w,p]}return l},t.minimaxWeights=function(t,r){void 0===r&&(r={constraints:{}}),void 0===r.constraints&&(r.constraints={});var o=!0;void 0!==r.constraints.fullInvestment&&(o=r.constraints.fullInvestment);var i=r.outputMinimumPortfolioReturn,e=t.length,a=t[0].length,s=n.fill(e+1,1,(function(t,r){return t<=e?0:-1})),u=null,l=null;o&&(u=n.fill(1,e+1,(function(t,r){return r<=e?1:0})),l=n.ones(1,1));var f=function(t,r,o,i,e,a,s,u){void 0===u&&(u={});var l=u.eps||1e-8,f=u.maxIter||1e5,h=!1,m=!1,c=!1;if(null!==t&&null!==r)h=!0;else{if(null!==t&&null===r)throw new Error("equality constraints vector is missing");if(null===t&&null!==r)throw new Error("equality constraints matrix is missing")}if(null!==o&&null!==i)m=!0;else{if(null!==o&&null===i)throw new Error("inequality constraints vector is missing");if(null===o&&null!==i)throw new Error("inequality constraints matrix is missing")}if(null!==a&&null!==s)c=!0;else{if(null!==a&&null===s)throw new Error("upper bounds constraints vector is missing");if(null===a&&null!==s)throw new Error("lower bounds constraints vector is missing")}if(!(e instanceof n))throw new Error("fifth input must be a matrix");if(1!==e.nbColumns)throw new Error("fifth input is not a vector: "+e.nbColumns+"-"+e.nbRows);if(h){if(!(t instanceof n))throw new Error("first input must be a matrix");if(!(r instanceof n))throw new Error("second input must be a matrix");if(t.nbRows!==r.nbRows)throw new Error("first and second inputs number of rows do not match: "+t.nbRows+"-"+r.nbRows);if(t.nbColumns!==e.nbRows)throw new Error("first input number of columns and fifth input number of rows do not match: "+t.nbColumns+"-"+e.nbRows);if(1!==r.nbColumns)throw new Error("second input is not a vector: "+r.nbColumns+"-"+r.nbRows)}if(m){if(!(o instanceof n))throw new Error("third input must be a matrix");if(!(i instanceof n))throw new Error("third input must be a matrix");if(o.nbRows!==i.nbRows)throw new Error("third and fourth inputs number of rows do not match: "+o.nbRows+"-"+i.nbRows);if(o.nbColumns!==e.nbRows)throw new Error("third input number of columns and fifth input number of rows do not match: "+o.nbColumns+"-"+e.nbRows);if(1!==i.nbColumns)throw new Error("fourth input is not a vector: "+i.nbColumns+"-"+i.nbRows)}if(c){if(null!==a.nbRows){if(!(a instanceof n))throw new Error("sixth input must be a matrix");if(a.nbRows!==e.nbRows)throw new Error("sixth input number of rows and fifth input number of rows do not match: "+a.nbRows+"-"+e.nbRows)}if(null!==s.nbRows){if(!(s instanceof n))throw new Error("seventh input must be a matrix");if(s.nbRows!==e.nbRows)throw new Error("seventh input number of rows and fifth input number of rows do not match: "+s.nbRows+"-"+e.nbRows)}}var d=0,w=null,p=null,v=null;h&&(d=t.nbRows,w=n.zeros(d,1),p=n.zeros(d,1),v=n.zeros(d,1));var b=0,y=null,g=null,x=null;m&&(b=o.nbRows,y=n.zeros(b,1),g=n.zeros(b,1),x=n.zeros(b,1));var C=e.nbRows,R=n.ones(C,1),E=n.ones(C,1),M=n.ones(C,1),A=n.zeros(C,1),P=n.zeros(C,1),z=n.zeros(C,1),k=null;h&&(k=n.zeros(d,1));var _=null;m&&(_=n.zeros(b,1));var I=n.fill(C,1,(function(r,n){var i=0;h&&(i+=t.vectorNorm("one","column",r));m&&(i+=o.vectorNorm("one","column",r));return 0==i&&(i=1),.9995/i})),V=null;h&&(V=n.fill(d,1,(function(r,n){var o=t.vectorNorm("one","row",r);return 0==o&&(o=1),.9995/o})));var F=null;m&&(F=n.fill(b,1,(function(t,r){var n=o.vectorNorm("one","row",t);return 0==n&&(n=1),.9995/n})));for(var O=0;;){if(-1!==f&&O>=f)throw new Error("maximum number of iterations reached: "+f);if(++O,h&&m?E=n.xpy(n.xpy(n.txy(t,w,P),n.txy(o,y,z),P),e,E):h?E=n.xpy(n.txy(t,w,P),e,E):m&&(E=n.xpy(n.txy(o,y,P),e,E)),E=n.xmy(R,n.elementwiseProduct(E,I,P),E),c)for(var T=1;T<=C;++T)E.data[T-1]<a.data[T-1]?E.data[T-1]=a.data[T-1]:E.data[T-1]>s.data[T-1]&&(E.data[T-1]=s.data[T-1]);else for(T=1;T<=C;++T)E.data[T-1]<0&&(E.data[T-1]=0);if(M=n.axpby(2,E,-1,R,M),h&&(p=n.xpy(w,n.elementwiseProduct(n.xmy(n.xy(t,M,k),r,k),V,k),p)),m){g=n.xpy(y,n.elementwiseProduct(n.xmy(n.xy(o,M,_),i,_),F,_),g);for(T=1;T<=b;++T)g.data[T-1]<0&&(g.data[T-1]=0)}var S=(A=n.xmy(E,R,A)).vectorNorm("infinity"),N=E.vectorNorm("infinity"),W=0,q=0;h&&(W=(v=n.xmy(p,w,v)).vectorNorm("infinity"),q=p.vectorNorm("infinity"));var B=0,L=0;if(m&&(B=(x=n.xmy(g,y,x)).vectorNorm("infinity"),L=g.vectorNorm("infinity")),S<=l*N&&W<=l*q&&B<=l*L)break;R=n.copy(E,R),h&&(w=n.copy(p,w)),m&&(y=n.copy(g,y))}return[E,n.vectorDotProduct(e,E)]}(u,l,n.fill(a+(o?0:1),e+1,(function(r,n){return r<=a?n<=e?-t[n-1][r-1]:1:r==a+1?n<=e?1:0:void 0})),n.fill(a+(o?0:1),1,(function(t,r){return t<=a?0:t==a+1?1:void 0})),s,n.fill(e+1,1,(function(t,r){return t<=e?0:-1/0})),n.fill(e+1,1,(function(t,r){return t<=e?1:1/0})),{maxIter:-1})[0],h=f.toArray((function(t,r,n){return t!=e+1})),m=f.data[e];return!0===i?[h,m]:h},t.minimumCorrelationWeights=function(r,o){var i=(r=new n(r).toCovarianceMatrix()).getVariances(),e=i.elemMap((function(t,r,n){return 1/Math.sqrt(n)})),a=r.getCorrelationMatrix(),s=a.nbRows;if(s<=2)return t.inverseVolatilityWeights(i,o);for(var u=a.toArray((function(t,r,n){return r>t})),l=x(u),f=R(u),h=a.elemMap((function(t,r,n){return t==r?0:1-E((n-l)/f)})),m=h.toRowArray((function(t,r,n){return t!=r})),c=new Array(s),d=0;d<s;++d)c[d]=x(m[d]);var w=new n(function(t,r){for(var n=new Array(t.length),o=0;o<t.length;++o)n[o]=[t[o],o];0==r?n.sort((function(t,r){return t[0]>r[0]?-1:1})):1==r&&n.sort((function(t,r){return t[0]<r[0]?-1:1}));var i=new Array(t.length);for(i[n[0][1]]=1,o=1;o<t.length;++o)n[o][0]==n[o-1][0]?i[n[o][1]]=i[n[o-1][1]]:i[n[o][1]]=o+1;return i}(c,0),1).normalize();return w=n.xy(h,w).normalize(),(w=n.vectorHadamardProduct(w,e).normalize()).toArray()},t.minimumTrackingErrorWeights=function(r,o,i){void 0===i&&(i={constraints:{}}),void 0===i.constraints&&(i.constraints={}),void 0===i.optimizationMethodParams&&(i.optimizationMethodParams={}),void 0===i.optimizationMethodParams.eps&&(i.optimizationMethodParams.eps=1e-4),void 0===i.optimizationMethodParams.maxIter&&(i.optimizationMethodParams.maxIter=1e4),void 0===i.constraints.minNbAssets&&i.constraints.maxNbAssets&&(i.constraints.minNbAssets=1),void 0===i.constraints.maxNbAssets&&i.constraints.minNbAssets&&(i.constraints.maxNbAssets=r.length);var e=i.optimizationMethodParams.eps,a=i.optimizationMethodParams.maxIter,s=!0;void 0!==i.constraints.fullInvestment&&(s=i.constraints.fullInvestment);var u=i.constraints.minNbAssets,f=i.constraints.maxNbAssets,h=u||f,m=i.optimizationMethodParams.nRounds;void 0===m&&(m=3);var c=i.optimizationMethodParams.nSteps;void 0===c&&(c=5e3);var d=i.optimizationMethodParams.nDeltas;void 0===d&&(d=c);var w=i.optimizationMethodParams.maxIterationsInitPoint;void 0===w&&(w=1e4);for(var p=r.length,v=r[0].length,b=(o=new n(o),r=n.fill(v,p,(function(t,n){return r[n-1][t-1]})),"function"==typeof Float64Array?new Float64Array(p):new Array(p)),y="function"==typeof Float64Array?new Float64Array(p):new Array(p),g=0;g<p;++g)b[g]=i.constraints.minWeights?i.constraints.minWeights[g]:0,y[g]=i.constraints.maxWeights?i.constraints.maxWeights[g]:1;if(h){function x(t,i){var e;t=new n(t);if(i){var a=i.x_c,s=i.x_c_updatedIndexes;i.f_x_c;e=new n(i.f_x_c_context.assetsReturnsTx_m_b);for(var u=0;u<s.length;++u)for(var l=s[u],f=t.data[l]-a[l],h=0;h<r.nbRows;++h)e.data[h]+=r.data[h*r.nbColumns+l]*f}else e=n.xmy(n.xy(r,t),o);var m=e.vectorNorm("two");return{f_x:.5*m*m,f_x_context:{assetsReturnsTx_m_b:e}}}try{var C=1;s||(C=Math.random()),M=t.randomWeights(p,{maxIter:w,constraints:{minExposure:C,maxExposure:1,minNbAssets:u,maxNbAssets:f,minWeights:b,maxWeights:y}})}catch(A){throw"maximum number of iterations reached"===A.message?new Error("infeasible problem detected"):A}var R=new l(p,void 0,!0),E=new n(k(x,M,{nSteps:c,nRounds:m,nDeltas:d,neighbourGenerator:function(t,r){for(var n=r.lowerBounds,o=r.upperBounds,i=t,e=0,a=1,l=0;l<p;++l)if(i[l]>0&&0==n[l]||i[l]>=n[l]&&n[l]>0){if(++e,a-=i[l],i[l]<n[l])throw new Error("internal error: asset present in the portfolio, but strictly below its lower bound");if(i[l]>o[l])throw new Error("internal error: asset present in the portfolio, but strictly above its upper bound")}if(a=Math.max(0,a),e>f)throw new Error("internal error: number of assets strictly greater than the allowed maximum number of assets");if(e<u)throw new Error("internal error: number of assets strictly lower than the allowed minimum number of assets");for(var h=[],m=R.next(),c=0;c<p;++c){if(i[l=m[c]-1]>0&&0==n[l]||i[l]>=n[l]&&n[l]>0){var d=i[l]-n[l],w=Math.min(0,d),v=i[l];s||(h.push([l,-1,w,d]),e>u&&h.push([l,-1,v]));for(var b=0;b<p;++b){if((i[b]<n[b]||0==i[b])&&i[b]<o[b]){var y=n[b],g=Math.max(y,o[b]-i[b]);if(e<f&&w<=y&&y<=d){var x=y,C=Math.min(g,d);h.push([l,b,x,C])}y<=v&&v<=g&&h.push([l,b,v])}if((i[b]>0&&0==n[b]||i[b]>=n[b]&&n[b]>0)&&i[b]<o[b]){g=o[b]-i[b],y=Math.min(0,g);if(e>u&&y<=v&&v<=g&&h.push([l,b,v]),w<=y&&y<=d){x=y,C=Math.min(g,d);h.push([l,b,x,C])}}}}var E=!1;if(0!=h.length&&(E=!0),!s){if((i[l]>0&&0==n[l]||i[l]>=n[l]&&n[l]>0)&&i[l]<o[l]){g=o[l]-i[l];if(a>=(y=Math.min(0,g))){x=y,C=Math.min(g,a);h.push([-1,l,x,C])}}if((i[l]<n[l]||0==i[l])&&i[l]<o[l]&&e<f){y=n[l],g=Math.max(y,o[l]-i[l]);if(a>=y){x=y,C=Math.min(g,a);h.push([-1,l,x,C])}}}if(E)break}if(0==h.length)throw new Error("internal error: no feasible switch");var M,A,P,z=h[(M=0,A=h.length,Math.floor(Math.random()*(A-M))+M)],k=[],_=z[0],I=z[1];if(3==z.length)P=z[2],-1!=_&&(i[_]=0,k.push(_)),-1!=I&&(i[I]+=P,k.push(I));else{if(4!=z.length)throw new Error("internal error: unexpected lenght of the switches structure");P=function(t,r){return Math.random()*(r-t)+t}(z[2],z[3]),-1!=_&&(i[_]-=P,k.push(_)),-1!=I&&(i[I]+=P,k.push(I))}return{xx:i,x_updated_indexes:k.filter((function(t,r,n){return n.indexOf(t)==r}))}},neighbourGeneratorParameters:{assetsRandomIterator:R,lowerBounds:b,upperBounds:y}})[0])}else{function x(t){var i=n.xmy(n.xy(r,t),o).vectorNorm("two");return.5*i*i}var M;E=I(x,(function(t){return n.txy(r,n.xmy(n.xy(r,t),o))}),(function(t){return T(t.data,b,y)}),(function(t){return new n(W(t.data,b,y))}),M=new n(W(n.ones(r.nbColumns,1).data,b,y)),{eps:e,maxIter:a,maxLine:a})[0]}return E.toArray()},t.mostDiversifiedWeights=function(t,r){void 0===r&&(r={}),void 0===r.constraints&&(r.constraints={}),void 0===r.optimizationMethodParams&&(r.optimizationMethodParams={});var o=r.epsVolatility;void 0===o&&(o=1e-4);var i=r.optimizationMethod;if(void 0===i&&(i="automatic"),"critical-line"!=i&&"gsmo"!=i&&"automatic"!=i)throw new Error("unsupported optimisation method");var e,a=new n(t).toCovarianceMatrix().getStandardDeviations();if("automatic"==i)e=new D(a,t,r);else if("critical-line"==i)e=new L(a,t,r);else{if("gsmo"!=i)throw new Error("internal error: unsupported optimisation method");e=new U(a,t,r)}e.restrict("minVolatility",o);return e.computeMaximumSharpeRatioEfficientPortfolio(0)[0].toArray()},t.numericalOptimizationWeights=function(t,r,n){void 0===n&&(n={}),void 0===n.constraints&&(n.constraints={}),void 0===n.optimizationMethodParams&&(n.optimizationMethodParams={});var o=n.optimizationMethod;if(void 0===o&&(o="grid-search"),"grid-search"===o&&void 0===n.optimizationMethodParams.k&&(n.optimizationMethodParams.k=t),"grid-search"===o)return function(t,r,n,o,i){var e=null,a=null;if(o&&(e=o,!i)){a="function"==typeof Float64Array?new Float64Array(r):new Array(r);for(var s=0;s<r;++s)a[s]=1}if(i&&(a=i,!o)){e="function"==typeof Float64Array?new Float64Array(r):new Array(r);for(s=0;s<r;++s)e[s]=0}if(e||a)N(r,e,a);for(var u=Number.POSITIVE_INFINITY,l=[],f=new q(r,n,!0),h=f.sample();-1!==h;){var m=!0;if(e)for(s=0;s<r;++s)if(e[s]>h[s]){m=!1;break}if(a)for(s=0;s<r;++s)if(h[s]>a[s]){m=!1;break}if(m){var c=t(h);c<u?(u=c,l=[h.slice(0)]):c==u&&l.push(h.slice(0)),h=f.sample()}else h=f.sample()}return l}(r,t,n.optimizationMethodParams.k,n.constraints.minWeights,n.constraints.maxWeights);throw new Error("unsupported optimisation method")},t.postOptimizationWeights=function(t,r){void 0===r&&(r={roundingOptimizationMethodParams:{}}),void 0===r.roundingOptimizationMethodParams&&(r.roundingOptimizationMethodParams={});var o=r.portfolioValue,i=r.assetsPrices,e=r.sizeLots;if(null==o||0==o)throw new Error("missing portfolio value");if(null==i)throw new Error("missing assets prices");null==e&&(e=n.ones(t.length,1).data);var a=r.roundingOptimizationMethodParams.nRounds;void 0===a&&(a=3);var s=r.roundingOptimizationMethodParams.nSteps;void 0===s&&(s=5e3);var u=r.roundingOptimizationMethodParams.nDeltas;void 0===u&&(u=s);var f=t.length,h=function(t,r,o){var i=t.length;S(i,r,o);var e=new n(t).elemMap((function(t,n,i){var e=r?r[t-1]:0,a=o?o[t-1]:1;return Math.max(-e,Math.min(a,i))})),a=n.ones(i,1);return n.vectorDotProduct(a,e)<=1?e.toArray():W(t,r,o)}(t),m=n.fill(f+1,1,(function(t,r){return t<=f?h[t-1]:0}));m.data[f]=1-m.sum();var c=n.fill(f+1,1,(function(t,r){return t<=f?e[t-1]*i[t-1]:1}));function d(t,r){if(r)var n=r.x_c,i=r.x_c_updatedIndexes,e=r.f_x_c;var a=0,s=1/o;if(i){a=e;for(var u=0;u<i.length;++u){var l=i[u],h=m.data[l],d=t[l]*c.data[l]*s,w=n[l]*c.data[l]*s;a+=Math.pow(h-d,2)-Math.pow(h-w,2)}}else for(l=0;l<f+1;++l)h=m.data[l],d=t[l]*c.data[l]*s,a+=Math.pow(h-d,2);return{f_x:a,f_x_context:{}}}for(var w=1,p=0;p<f;++p)m.data[p]>1e-12&&++w;for(var v="function"==typeof UInt32Array?new UInt32Array(w):new Array(w),b=(p=0,0);p<f;++p)m.data[p]>1e-12&&(v[b]=p,++b);v[w-1]=f;var y=n.zeros(f+1,1).data;y[f]=o;for(b=0;b<w-1;++b){y[p=v[b]]=Math.floor(m.data[p]*o/c.data[p]),y[f]-=y[p]*c.data[p]}if(y[f]<0)throw new Error("internal error: negative cash during intitial feasible point generation");for(;;){var g=-1,x=d(y).f_x;for(b=0;b<w-1;++b){p=v[b];if(c.data[p]<=y[f]){y[p]+=1,y[f]-=c.data[p];var C=d(y).f_x;C<x&&(g=p,x=C),y[p]-=1,y[f]+=c.data[p]}}if(-1==g)break;y[g]+=1,y[f]-=c.data[g]}if(y[f]<0)throw new Error("internal error: negative cash during intitial feasible point generation");var R=k(d,y,{nSteps:s,nRounds:a,nDeltas:u,neighbourGenerator:function(t,r){function n(t,r){return Math.floor(Math.random()*(r-t))+t}for(var o,i=r.workingAssetsRandomIterator.next(),e=0;e<i.length&&(0==t[o=i[e]]&&o!=f);++e);var a=[];if(o!=f){var s=n(1,t[o]+1);t[o]-=s;var u=c.data[o]*s;t[f]+=u,a.push(o),a.push(f)}var l,h,m=r.workingAssetsRandomIterator.next();for(e=0;e<m.length&&(l=m[e])!=f&&0==(h=Math.floor(t[f]/c.data[l]));++e);if(l!=f){var d=n(1,h+1);t[l]+=d;var w=c.data[l]*d;t[f]-=w,a.push(l),a.push(f)}return{xx:t,x_updated_indexes:a.filter((function(t,r,n){return n.indexOf(t)==r}))}},neighbourGeneratorParameters:{workingAssetsRandomIterator:new l(null,v.slice(),!0)}})[0],E=new n.fill(f,1,(function(t,r){return R[t-1]*c.data[t-1]/o})).toArray();return[new n.fill(f,1,(function(t,r){return R[t-1]})).toArray(),E,R[f]]},t.proportionalMinimumVarianceWeights=function(t,r){for(var o=(t=new n(t)).nbRows,i=t.toRowArray(),e=new Array(o),a=0;a<o;++a)e[a]=x(i[a]);var s=x(e),u=R(e),l=new n(e,1).elemMap((function(t,r,n){return 1-E((n-s)/u)}));l=l.normalize(l);var f=t.diagonal().elemMap((function(t,r,n){return 1/n})).normalize();return(l=n.vectorHadamardProduct(l,f).normalize()).toArray()},t.randomSubspaceOptimizationWeights=function(t,r,o){void 0===o&&(o={}),void 0===o.constraints&&(o.constraints={}),void 0===o.subsetOptimizationFctOpt&&(o.subsetOptimizationFctOpt={}),void 0===o.subsetOptimizationFctOpt.constraints&&(o.subsetOptimizationFctOpt.constraints={});var i=o.constraints.minWeights;null==i&&(i=n.zeros(t,1).data);var e=o.constraints.maxWeights;if(null==e&&(e=n.ones(t,1).data),t<=1)return[1];var a=o.sizeSubsets;if(void 0===a&&(a=Math.max(2,Math.floor(Math.sqrt(t)))),a<=1||a>=t+1)throw new Error("the size of the subsets of assets must be between 2 and "+t.toString());var s=o.subsetsGenerationMethod;void 0===s&&(s="random");var u,l=o.nbRandomSubsets;if(void 0===l&&(l=128),a===t&&(l=1),"random"===s)u=l;else{if("deterministic"!==s)throw new Error("unsupported subsets of assets generation method");u=function(t,r){if(t<0)throw new Error("n must be a positive integer");if(r<0)throw new Error("k must be a positive integer");if(r>t)throw new Error("k must be less than or equal to n");for(var n=1,o=1;o<=r;++o)n*=t+1-o,n/=o;return n}(t,a)}var m=o.subsetsAggregationMethod;if(void 0===m&&(m="average"),"average"!==m&&"median"!==m)throw new Error("unsupported aggregation method");var d,w=o.maxInfeasibleSubsetsRatio;if(void 0===w&&(w=0),"random"===s)d=new h(t,a,!1);else{if("deterministic"!==s)throw new Error("unsupported subsets generation method");d=new f(t,a,!1)}for(var p=o.subsetOptimizationFctOpt,v=0,b=new Array(u),y=0;y<u;++y){var x=d.next();p.constraints.minWeights="function"==typeof Float64Array?new Float64Array(a):new Array(a);for(var C=0;C<a;++C)p.constraints.minWeights[C]=i[x[C]-1];p.constraints.maxWeights="function"==typeof Float64Array?new Float64Array(a):new Array(a);for(C=0;C<a;++C)p.constraints.maxWeights[C]=e[x[C]-1];try{var R=r(x,p);if(R.length!=a)throw new Error("internal error: the portfolio optimization method did not return the expected number of weights")}catch(A){if("infeasible portfolio optimization problem"===A.message)continue;throw A}var E=n.zeros(t,1);for(C=0;C<a;++C)E.setValueAt(x[C],1,R[C]);b[v++]=E}if(b.length=v,0===v)throw new Error("no feasible portfolio generated");var M=u-v;if(M>=1&&M/u>=w)throw new Error("too many infeasible portfolios generated");E=null;if("average"==m)E=c(b);else{if("median"!=m)throw new Error("internal error");E=function(t){function r(r){for(var o=0,e=0;e<i;++e){o+=g(n.xmy(r,t[e],a).vectorNorm("two"),f)}return o}function o(r){for(var o=n.zeros(e,1),s=0;s<i;++s){var u=n.xmy(r,t[s],a),l=u.vectorNorm("two");o=n.axpby(1,o,1/g(l,f),u,o)}return o}var i=t.length,e=t[0].nbRows,a=n.zeros(e,1),s=c(t),u=function(t){return 0},l=function(t,r){return t},f=1/i,h=I(r,o,u,l,s,{eps:1e-4,maxIter:-1,maxLine:-1});return f=.1/i,h=I(r,o,u,l,h[0],{eps:1e-4,maxIter:-1,maxLine:-1}),f=.01/i,(h=I(r,o,u,l,h[0],{eps:1e-4,maxIter:-1,maxLine:-1}))[0]}(b)}return E.toArray()},t.randomSubspaceMeanVarianceOptimizationWeights=function(r,o,i){void 0===i&&(i={}),void 0===i.constraints&&(i.constraints={}),void 0===i.subsetsOpt&&(i.subsetsOpt={}),void 0===i.subsetsOpt.constraints&&(i.subsetsOpt.constraints={});var e=i.constraints.minExposure;null==e&&(e=1);var a=i.constraints.maxExposure;null==a&&(a=1);r=new n(r);var s=(o=new n(o)).nbColumns;if(void 0===i.sizeSubsets){var u=-2*Math.sqrt(s*(s+3)/2),l=2.25-1*u,f=u/-(1.5+Math.sqrt(l));i.sizeSubsets=Math.max(2,Math.floor(f))}return i.subsetOptimizationFctOpt=i.subsetsOpt,t.randomSubspaceOptimizationWeights(s,(function(i,s){var u=i.length,l=r.submatrix(i,[1]),f=o.submatrix(i,i);1!=e&&(l=n.fill(u+1,1,(function(t,r){return t<=u?l.getValue(t,1):0})),f=n.fill(u+1,u+1,(function(t,r){return t<=u&&r<=u?f.getValue(t,r):0})),s.constraints.minWeights=n.fill(u+1,1,(function(t,r){return t<=u?s.constraints.minWeights[t-1]:1-a})).data,s.constraints.maxWeights=n.fill(u+1,1,(function(t,r){return t<=u?s.constraints.maxWeights[t-1]:1-e})).data);try{var h=t.meanVarianceOptimizationWeights(l,f,s);return 1!=e&&(h=h.slice(0,u)),h}catch(m){throw m.message.includes("no matching efficient portfolio")||"infeasible problem detected: the restricted simplex is empty"===m.message?new Error("infeasible portfolio optimization problem"):m}}),i)},t.randomSubspaceGlobalMinimumVarianceOptimizationWeights=function(r,o){void 0===o&&(o={}),void 0===o.constraints&&(o.constraints={}),void 0===o.subsetsOpt&&(o.subsetsOpt={}),void 0===o.subsetsOpt.optimizationMethodParams&&(o.subsetsOpt.optimizationMethodParams={}),void 0===o.subsetsOpt.constraints&&(o.subsetsOpt.constraints={});var i=o.constraints.minExposure;null==i&&(i=1);var e=o.constraints.maxExposure;null==e&&(e=1);var a=(r=new n(r)).nbColumns;if(void 0===o.sizeSubsets){var s=null==m?1:3,u=null==m?-2*Math.sqrt(a*(a+1)/2):-2*Math.sqrt(a*(a+3)/2),l=s/2,f=l*l-1*u,h=u/-(l+Math.sqrt(f));o.sizeSubsets=Math.max(2,Math.floor(h))}var m=o.mu;return m=null==m?n.zeros(a,1):new n(m),o.subsetOptimizationFctOpt=o.subsetsOpt,t.randomSubspaceOptimizationWeights(a,(function(o,a){var s=o.length,u=r.submatrix(o,o),l=m.submatrix(o,[1]);a.mu=l,1!=i&&(l=n.fill(s+1,1,(function(t,r){return t<=s?l.getValue(t,1):0})),a.mu=l,u=n.fill(s+1,s+1,(function(t,r){return t<=s&&r<=s?u.getValue(t,r):0})),a.constraints.minWeights=n.fill(s+1,1,(function(t,r){return t<=s?a.constraints.minWeights[t-1]:1-e})).data,a.constraints.maxWeights=n.fill(s+1,1,(function(t,r){return t<=s?a.constraints.maxWeights[t-1]:1-i})).data);try{var f=t.globalMinimumVarianceWeights(u,a);return 1!=i&&(f=f.slice(0,s)),f}catch(h){throw"infeasible problem detected: the restricted simplex is empty"===h.message?new Error("infeasible portfolio optimization problem"):h}}),o)},t.randomSubspaceMaximumSharpeRatioWeights=function(r,o,i,e){void 0===e&&(e={}),void 0===e.constraints&&(e.constraints={}),void 0===e.subsetsOpt&&(e.subsetsOpt={}),void 0===e.subsetsOpt.optimizationMethodParams&&(e.subsetsOpt.optimizationMethodParams={}),void 0===e.subsetsOpt.constraints&&(e.subsetsOpt.constraints={});var a=e.constraints.minExposure;null==a&&(a=1);var s=e.constraints.maxExposure;null==s&&(s=1);r=new n(r);var u=(o=new n(o)).nbColumns;if(void 0===e.sizeSubsets){var l=-2*Math.sqrt(u*(u+3)/2),f=2.25-1*l,h=l/-(1.5+Math.sqrt(f));e.sizeSubsets=Math.max(2,Math.floor(h))}return e.subsetOptimizationFctOpt=e.subsetsOpt,t.randomSubspaceOptimizationWeights(u,(function(e,u){var l=e.length,f=r.submatrix(e,[1]),h=o.submatrix(e,e);1!=a&&(f=n.fill(l+1,1,(function(t,r){return t<=l?f.getValue(t,1):0})),h=n.fill(l+1,l+1,(function(t,r){return t<=l&&r<=l?h.getValue(t,r):0})),u.constraints.minWeights=n.fill(l+1,1,(function(t,r){return t<=l?u.constraints.minWeights[t-1]:1-s})).data,u.constraints.maxWeights=n.fill(l+1,1,(function(t,r){return t<=l?u.constraints.maxWeights[t-1]:1-a})).data);try{var m=t.maximumSharpeRatioWeights(f,h,i,u);return 1!=a&&(m=m.slice(0,l)),m}catch(c){throw"infeasible problem detected: the restricted simplex is empty"===c.message||"impossible to restrict the efficient frontier: the minimum return constraint is not feasible"===c.message||"impossible to restrict the efficient frontier: the minimum volatility constraint is not feasible"===c.message?new Error("infeasible portfolio optimization problem"):c}}),e)},t.randomWeights=function(t,r){void 0===r&&(r={}),void 0===r.constraints&&(r.constraints={});var o=r.constraints.minNbAssets||r.constraints.maxNbAssets,i=r.constraints.minNbAssets;void 0===i&&(i=1);var e=r.constraints.maxNbAssets;void 0===e&&(e=t);var a=r.constraints.minExposure;void 0===a&&(a=1);var s=r.constraints.maxExposure;void 0===s&&(s=1);var u=r.maxIter;void 0===u&&(u=1e4);for(var l=-1;;){if(++l,-1!==u&&l>u)throw new Error("maximum number of iterations reached");var f=Math.floor(Math.random()*(e-i+1))+i,m=new h(t,f,!1).next(),c=Math.random()*(s-a)+a,d=0;if(1!==c){d=1;for(var w="function"==typeof Float64Array?new Float64Array(f+d):new Array(f+d),p="function"==typeof Float64Array?new Float64Array(f+d):new Array(f+d),v=0;v<f;++v)w[v]=0,p[v]=1;var b=1-c;w[f]=b,p[f]=b}if(r.constraints.minWeights){if(1===c)w="function"==typeof Float64Array?new Float64Array(f):new Array(f);for(v=0;v<f;++v)w[v]=r.constraints.minWeights[m[v]-1]}if(r.constraints.maxWeights){if(1===c)p="function"==typeof Float64Array?new Float64Array(f):new Array(f);for(v=0;v<f;++v)p[v]=r.constraints.maxWeights[m[v]-1]}try{N(f+d,w,p)}catch(R){continue}var y=new B(f+d,w,p).sample();try{if(o)for(v=0;v<f;++v)if(0==y[v])throw new Error("generated weights not compatible with cardinality constraints")}catch(R){continue}break}var g=n.zeros(t,1);for(v=0;v<f;++v){var x=m[v],C=y[v];g.setValueAt(x,1,C)}return g.toArray()},t.riskBudgetingWeights=function(t,r,o){function i(t,r){var o=n.vectorDotProduct(r,t);if(Math.abs(o)<=f)o=0;else if(o<0&&o<-f)throw new Error("negative volatility, covariance matrix might not be semi-definite positive");return Math.sqrt(o)}function e(e,s,l){for(var f=n.fill(d,1,(function(t,r){return 1/d})),c=f.elemMap((function(t,r,n){return Math.log(n)})),w=(n.copy(f),n.xy(t,f)),p=i(f,w),v=n.vectorDotProduct(r,c),b=.5*p-v,y=new a(d),g=0;-1==m||g!=m;){if(-1==m&&-1!=h&&g>=h)throw new Error("maximum number of cycles reached: "+h);var x;for(++g,y.generateCoordinates();;){var C=y.sampleCoordinate();if(-1==C)break;"acf"===o.coordinatesSampler&&(x=.5*p-v);var R=f.data[C-1],E=c.data[C-1],M=t.data[(C-1)*t.nbColumns+(C-1)],A=w.data[C-1]-f.data[C-1]*M,P=-e*r.data[C-1]*p,z=A/2,k=z>=0?1:-1,_=z*z-M*P;if(_<0)throw new Error("internal error: negative discriminant detected, the covariance matrix might not be semi-definite positive");var I,V=-(z+k*Math.sqrt(_)),F=V/M,O=P/V;if(F>0)I=F;else{if(!(O>0))throw new Error("internal error: no strictly positive root detected, the covariance matrix might not be semi-definite positive");I=O}s&&I<s[C-1]&&(I=s[C-1]),l&&I>l[C-1]&&(I=l[C-1]),f.data[C-1]=I,c.data[C-1]=Math.log(I),v-=E*r.data[C-1],v+=c.data[C-1]*r.data[C-1];for(var T=1;T<=d;++T)w.data[T-1]+=t.data[(T-1)*t.nbColumns+(C-1)]*I,w.data[T-1]-=t.data[(T-1)*t.nbColumns+(C-1)]*R;if(p=i(f,w),"acf"===o.coordinatesSampler){var S=x-(.5*p-v);1==g?y.updateAverageGain(S):y.updateSchedulingPreference(C,S)}}var N=.5*p-v;if(-1==m&&Math.abs(N-b)<=u)break;b=N}return f}void 0===o&&(o={}),void 0===o.constraints&&(o.constraints={}),void 0===o.eps&&(o.eps=1e-10),void 0===o.epsSdp&&(o.epsSdp=1e-12),void 0===o.maxCycles&&(o.maxCycles=1e4),void 0===o.nbCycles&&(o.nbCycles=-1),void 0===o.outputPortfolioVolatility&&(o.outputPortfolioVolatility=!1),void 0===o.coordinatesSampler&&(o.coordinatesSampler="cyclic");var a,u=o.eps,f=o.epsSdp,h=o.maxCycles,m=o.nbCycles,c=o.outputPortfolioVolatility;if("cyclic"===o.coordinatesSampler)a=function(t){this.n=t,this.k=t,this.sampleCoordinate=function(){return this.k==this.n?-1:++this.k},this.generateCoordinates=function(){this.k=0}};else if("shuffledCyclic"===o.coordinatesSampler)a=function(t){this.n=t,this.k=t,this.r="function"==typeof Uint32Array?new Uint32Array(t):new Array(t);for(var r=0;r<t;++r)this.r[r]=r+1;this.sampleCoordinate=function(){return this.k==this.n?-1:this.r[this.k++]},this.generateCoordinates=function(){this.r=new l(void 0,this.r,!0).next(),this.k=0}};else if("randomized"===o.coordinatesSampler)a=function(t){this.n=t,this.k=t;for(var r="function"==typeof Float64Array?new Float64Array(t):new Array(t),n=0;n<t;++n)r[n]=1/t;this.s=new s(r),this.sampleCoordinate=function(){return this.k==this.n?-1:(++this.k,this.s.sample()+1)},this.generateCoordinates=function(){this.k=0}};else{if("acf"!==o.coordinatesSampler)throw new Error("unsupported coordinates sampler");a=function(t){this.n=t,this.k=0,this.change_rate=.2,this.p_min=.05,this.p_max=20,this.idx_set_tmp="function"==typeof Uint32Array?new Uint32Array(2*t):new Array(2*t),this.idx_set=null,this.idx_set_len=0,this.pref="function"==typeof Float64Array?new Float64Array(t):new Array(t);for(var r=0;r<t;++r)this.pref[r]=1;for(this.prefsum=t,this.acc="function"==typeof Float64Array?new Float64Array(t):new Array(t),r=0;r<t;++r)this.acc[r]=.5;this.gain_learning_rate=1/t,this.average_gain=0,this.sampleCoordinate=function(){return this.k==this.idx_set_len?-1:this.idx_set[this.k++]},this.generateCoordinates=function(){this.k=0,this.idx_set_len=0;for(var t=this.n/this.prefsum,r=0;r<this.n;++r){for(var n=this.acc[r]+t*this.pref[r],o=Math.floor(n),i=0;i<o;++i)this.idx_set_tmp[this.idx_set_len]=r+1,this.idx_set_len++;this.acc[r]=n-o}this.idx_set=new l(void 0,this.idx_set_tmp.slice(0,this.idx_set_len),!0).next()},this.updateSchedulingPreference=function(t,r){var n=this.pref[t-1]*Math.exp(this.change_rate*(r/this.average_gain-1));n<this.p_min?n=this.p_min:n>this.p_max&&(n=this.p_max),this.prefsum=this.prefsum+n-this.pref[t-1],this.pref[t-1]=n,this.average_gain=(1-this.gain_learning_rate)*this.average_gain+this.gain_learning_rate*r},this.updateAverageGain=function(t){this.average_gain+=t/this.n}}}var d=(t=new n(t)).nbRows,w=(r=new n(r),null),p=null;if(o.constraints.minWeights&&(w=o.constraints.minWeights,!o.constraints.maxWeights)){p="function"==typeof Float64Array?new Float64Array(d):new Array(d);for(var v=0;v<p.length;++v)p[v]=1}if(o.constraints.maxWeights&&(p=o.constraints.maxWeights,!o.constraints.minWeights)){w="function"==typeof Float64Array?new Float64Array(d):new Array(d);for(v=0;v<w.length;++v)w[v]=0}var b,y=e(1);if(y=y.normalize(),w||p){N(d,w,p);for(var g=i(y,n.xy(t,y)),x=.5*g,C=e(x,w,p),R=0,E=54,M=!1;C.sum()-1>0;){if(++R>E)throw new Error("internal error: maximum number of iterations reached when searching for a bracketing interval, the problem might be infeasible");if(Math.abs(C.sum()-1)<=u){M=!0;break}C=e(x*=.5,w,p)}for(var A=2*g,P=e(A,w,p),z=(R=0,E=54,!1);P.sum()-1<0;){if(++R>E)throw new Error("internal error: maximum number of iterations reached when searching for a bracketing interval, the problem might be infeasible");if(Math.abs(P.sum()-1)<=u){z=!0;break}P=e(A*=2,w,p)}if(M)b=C;else if(z)b=P;else{var k=_((function(t){return e(t,w,p).sum()-1}),x,A);b=e(k,w,p)}}else b=y;return!0===c?[b.toArray(),i(b,n.xy(t,b))]:b.toArray()},t}(o||{}),t.exports=o}}]);
//# sourceMappingURL=993067c1-8990390e6ffefa1fcc71.js.map